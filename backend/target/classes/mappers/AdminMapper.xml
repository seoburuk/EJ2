<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ej2.mapper.AdminMapper">

    <!-- ==================== ダッシュボード基本統計 ==================== -->
    <select id="selectDashboardStats" resultType="com.ej2.dto.DashboardStatsDTO">
        SELECT
            (SELECT COUNT(*) FROM users) AS totalUsers,
            (SELECT COUNT(*) FROM users WHERE role = 'ADMIN') AS adminCount,
            (SELECT COUNT(*) FROM boards) AS totalBoards,
            (SELECT COUNT(*) FROM posts) AS totalPosts,
            (SELECT COUNT(*) FROM comments) AS totalComments,
            (SELECT COUNT(*) FROM users
             WHERE created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)) AS newUsersThisWeek,
            (SELECT COUNT(*) FROM posts
             WHERE created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)) AS newPostsThisWeek
    </select>

    <!-- ==================== 週間トレンド（7日間） ==================== -->
    <!--
        MariaDBで過去7日間の日別統計を生成します。
        データがない日は0で表示されます。
    -->
    <select id="selectWeeklyStats" resultType="com.ej2.dto.WeeklyStatDTO">
        SELECT
            DATE(d.date) AS date,
            COALESCE(u.cnt, 0) AS userCount,
            COALESCE(p.cnt, 0) AS postCount,
            COALESCE(c.cnt, 0) AS commentCount
        FROM (
            SELECT DATE_SUB(CURDATE(), INTERVAL 6 DAY) AS date UNION ALL
            SELECT DATE_SUB(CURDATE(), INTERVAL 5 DAY) UNION ALL
            SELECT DATE_SUB(CURDATE(), INTERVAL 4 DAY) UNION ALL
            SELECT DATE_SUB(CURDATE(), INTERVAL 3 DAY) UNION ALL
            SELECT DATE_SUB(CURDATE(), INTERVAL 2 DAY) UNION ALL
            SELECT DATE_SUB(CURDATE(), INTERVAL 1 DAY) UNION ALL
            SELECT CURDATE()
        ) d
        LEFT JOIN (
            SELECT DATE(created_at) AS dt, COUNT(*) AS cnt
            FROM users
            WHERE created_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
            GROUP BY DATE(created_at)
        ) u ON d.date = u.dt
        LEFT JOIN (
            SELECT DATE(created_at) AS dt, COUNT(*) AS cnt
            FROM posts
            WHERE created_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
            GROUP BY DATE(created_at)
        ) p ON d.date = p.dt
        LEFT JOIN (
            SELECT DATE(created_at) AS dt, COUNT(*) AS cnt
            FROM comments
            WHERE created_at >= DATE_SUB(CURDATE(), INTERVAL 7 DAY)
            GROUP BY DATE(created_at)
        ) c ON d.date = c.dt
        ORDER BY d.date ASC
    </select>

    <!-- ==================== 最近のアクティビティフィード ==================== -->
    <!--
        複数テーブルの最近のアクティビティをUNION ALLで結合し、時間順でソートします。
        type: USER_JOINED（新規登録）, POST_CREATED（投稿作成）, COMMENT_ADDED（コメント追加）
    -->
    <select id="selectRecentActivity" resultType="com.ej2.dto.ActivityDTO">
        SELECT * FROM (
            SELECT
                'USER_JOINED' AS type,
                u.id AS id,
                u.name AS content,
                u.created_at AS createdAt
            FROM users u

            UNION ALL

            SELECT
                'POST_CREATED' AS type,
                p.id AS id,
                p.title AS content,
                p.created_at AS createdAt
            FROM posts p

            UNION ALL

            SELECT
                'COMMENT_ADDED' AS type,
                c.id AS id,
                SUBSTRING(c.content, 1, 50) AS content,
                c.created_at AS createdAt
            FROM comments c
        ) activities
        ORDER BY createdAt DESC
        LIMIT #{limit}
    </select>

    <!-- ==================== ユーザー一覧（ページネーション） ==================== -->
    <select id="selectUsers" resultType="com.ej2.model.User">
        SELECT
            id,
            username,
            name,
            email,
            role,
            created_at AS createdAt,
            updated_at AS updatedAt
        FROM users
        ORDER BY created_at DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- ==================== ユーザー数取得 ==================== -->
    <select id="countUsers" resultType="int">
        SELECT COUNT(*) FROM users
    </select>

    <!-- ==================== ユーザー権限変更 ==================== -->
    <update id="updateUserRole">
        UPDATE users
        SET role = #{role}, updated_at = NOW()
        WHERE id = #{userId}
    </update>

    <!-- ==================== ユーザー削除 ==================== -->
    <delete id="deleteUser">
        DELETE FROM users WHERE id = #{userId}
    </delete>

    <!-- ==================== 掲示板別投稿統計 ==================== -->
    <!--
        各掲示板の総投稿数と1週間の増加数を取得します。
        投稿数順でソートし、最大10件を返します。
    -->
    <select id="selectBoardPostStats" resultType="com.ej2.dto.BoardPostStatsDTO">
        SELECT
            b.id AS boardId,
            b.name AS boardName,
            COALESCE(total.cnt, 0) AS totalPosts,
            COALESCE(weekly.cnt, 0) AS weeklyIncrease
        FROM boards b
        LEFT JOIN (
            SELECT board_id, COUNT(*) AS cnt
            FROM posts
            GROUP BY board_id
        ) total ON b.id = total.board_id
        LEFT JOIN (
            SELECT board_id, COUNT(*) AS cnt
            FROM posts
            WHERE created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
            GROUP BY board_id
        ) weekly ON b.id = weekly.board_id
        ORDER BY totalPosts DESC
        LIMIT 10
    </select>

</mapper>
