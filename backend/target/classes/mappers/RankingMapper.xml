<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ej2.mapper.RankingMapper">

    <!-- 기간별 WHERE 조건 SQL 프래그먼트 -->
    <sql id="periodCondition">
        <choose>
            <when test="period == 'daily'">
                AND p.created_at >= DATE_SUB(NOW(), INTERVAL 1 DAY)
            </when>
            <when test="period == 'weekly'">
                AND p.created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
            </when>
            <when test="period == 'monthly'">
                AND p.created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
            </when>
            <!-- 'all'인 경우 조건 없음 -->
        </choose>
    </sql>

    <!-- 인기도 점수 계산 SQL 프래그먼트 -->
    <!--
        공식: (like*3 + comment*2 + scrap*2.5 + view*0.1 - dislike*1) / (hours + 2)^1.0
        Gravity 1.0 = 약한 감쇠 (오래된 인기글도 상위 유지 가능)
    -->
    <sql id="popularityScore">
        (
            (COALESCE(p.like_count, 0) * 3.0) +
            (COALESCE(p.comment_count, 0) * 2.0) +
            (COALESCE(p.scrap_count, 0) * 2.5) +
            (COALESCE(p.view_count, 0) * 0.1) -
            (COALESCE(p.dislike_count, 0) * 1.0)
        ) / POW(
            GREATEST(TIMESTAMPDIFF(HOUR, p.created_at, NOW()), 0) + 2,
            1.0
        )
    </sql>

    <!-- 전체 인기글 조회 -->
    <select id="selectPopularPosts" resultType="com.ej2.dto.PopularPostDTO">
        SELECT
            p.id,
            p.board_id AS boardId,
            p.user_id AS userId,
            p.title,
            p.content,
            p.anonymous_id AS anonymousId,
            p.view_count AS viewCount,
            p.like_count AS likeCount,
            p.dislike_count AS dislikeCount,
            p.comment_count AS commentCount,
            p.scrap_count AS scrapCount,
            p.created_at AS createdAt,
            p.updated_at AS updatedAt,
            b.name AS boardName,
            u.name AS authorNickname,
            <include refid="popularityScore"/> AS popularityScore
        FROM posts p
        LEFT JOIN boards b ON p.board_id = b.id
        LEFT JOIN users u ON p.user_id = u.id
        WHERE p.is_blinded = FALSE
            AND p.is_notice = FALSE
            <include refid="periodCondition"/>
        ORDER BY popularityScore DESC, p.created_at DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 게시판별 인기글 조회 -->
    <select id="selectPopularPostsByBoard" resultType="com.ej2.dto.PopularPostDTO">
        SELECT
            p.id,
            p.board_id AS boardId,
            p.user_id AS userId,
            p.title,
            p.content,
            p.anonymous_id AS anonymousId,
            p.view_count AS viewCount,
            p.like_count AS likeCount,
            p.dislike_count AS dislikeCount,
            p.comment_count AS commentCount,
            p.scrap_count AS scrapCount,
            p.created_at AS createdAt,
            p.updated_at AS updatedAt,
            b.name AS boardName,
            u.name AS authorNickname,
            <include refid="popularityScore"/> AS popularityScore
        FROM posts p
        LEFT JOIN boards b ON p.board_id = b.id
        LEFT JOIN users u ON p.user_id = u.id
        WHERE p.is_blinded = FALSE
            AND p.is_notice = FALSE
            AND p.board_id = #{boardId}
            <include refid="periodCondition"/>
        ORDER BY popularityScore DESC, p.created_at DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 인기글 총 개수 -->
    <select id="countPopularPosts" resultType="int">
        SELECT COUNT(*)
        FROM posts p
        WHERE p.is_blinded = FALSE
            AND p.is_notice = FALSE
            <if test="boardId != null">
                AND p.board_id = #{boardId}
            </if>
            <include refid="periodCondition"/>
    </select>

</mapper>
