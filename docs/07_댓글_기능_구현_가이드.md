# 07. ëŒ“ê¸€ ê¸°ëŠ¥ êµ¬í˜„ ê°€ì´ë“œ

> ì´ ë¬¸ì„œëŠ” EJ2 í”„ë¡œì íŠ¸ì˜ **ëŒ“ê¸€(Comment)** ê¸°ëŠ¥ì„ ì„¤ëª…í•©ë‹ˆë‹¤.
> ëŒ€ëŒ“ê¸€(ì¤‘ì²© ëŒ“ê¸€), ì¢‹ì•„ìš” í† ê¸€, ì†Œí”„íŠ¸ ì‚­ì œ, ìµëª… ëŒ“ê¸€ ì‹œìŠ¤í…œì„ ë‹¤ë£¹ë‹ˆë‹¤.

---

## ëª©ì°¨

1. [ì „ì²´ íë¦„ ì´í•´í•˜ê¸°](#1-ì „ì²´-íë¦„-ì´í•´í•˜ê¸°)
2. [ë°±ì—”ë“œ êµ¬í˜„](#2-ë°±ì—”ë“œ-êµ¬í˜„)
   - 2.1 [Comment ì—”í‹°í‹°](#21-comment-ì—”í‹°í‹°)
   - 2.2 [CommentDTO](#22-commentdto)
   - 2.3 [CommentService (ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§)](#23-commentservice-ë¹„ì¦ˆë‹ˆìŠ¤-ë¡œì§)
   - 2.4 [CommentController (API)](#24-commentcontroller-api)
3. [í”„ë¡ íŠ¸ì—”ë“œ êµ¬í˜„](#3-í”„ë¡ íŠ¸ì—”ë“œ-êµ¬í˜„)
   - 3.1 [CommentSection ì»´í¬ë„ŒíŠ¸](#31-commentsection-ì»´í¬ë„ŒíŠ¸)
   - 3.2 [ëŒ“ê¸€ ì‘ì„± í¼](#32-ëŒ“ê¸€-ì‘ì„±-í¼)
   - 3.3 [ëŒ€ëŒ“ê¸€ êµ¬í˜„](#33-ëŒ€ëŒ“ê¸€-êµ¬í˜„)
   - 3.4 [ì¢‹ì•„ìš” í† ê¸€](#34-ì¢‹ì•„ìš”-í† ê¸€)
   - 3.5 [ìˆ˜ì •/ì‚­ì œ ê¸°ëŠ¥](#35-ìˆ˜ì •ì‚­ì œ-ê¸°ëŠ¥)
4. [ëŒ€ëŒ“ê¸€ ë°ì´í„° êµ¬ì¡°](#4-ëŒ€ëŒ“ê¸€-ë°ì´í„°-êµ¬ì¡°)
5. [ì†Œí”„íŠ¸ ì‚­ì œ vs í•˜ë“œ ì‚­ì œ](#5-ì†Œí”„íŠ¸-ì‚­ì œ-vs-í•˜ë“œ-ì‚­ì œ)
6. [ìµëª… ëŒ“ê¸€ ì‹œìŠ¤í…œ](#6-ìµëª…-ëŒ“ê¸€-ì‹œìŠ¤í…œ)
7. [ìì£¼ ë°œìƒí•˜ëŠ” ì—ëŸ¬ì™€ í•´ê²°ë²•](#7-ìì£¼-ë°œìƒí•˜ëŠ”-ì—ëŸ¬ì™€-í•´ê²°ë²•)

---

## 1. ì „ì²´ íë¦„ ì´í•´í•˜ê¸°

### ëŒ“ê¸€ ì‹œìŠ¤í…œ êµ¬ì¡°

```
ê²Œì‹œê¸€ (Post ID: 10)
â”œâ”€â”€ ëŒ“ê¸€ 1 (parentId: null) â† ìµœìƒìœ„ ëŒ“ê¸€
â”‚   â”œâ”€â”€ ëŒ€ëŒ“ê¸€ 3 (parentId: 1) â† ëŒ“ê¸€ 1ì— ëŒ€í•œ ë‹µê¸€
â”‚   â””â”€â”€ ëŒ€ëŒ“ê¸€ 4 (parentId: 1)
â”œâ”€â”€ ëŒ“ê¸€ 2 (parentId: null)
â”‚   â””â”€â”€ ëŒ€ëŒ“ê¸€ 5 (parentId: 2)
â””â”€â”€ ëŒ“ê¸€ 6 (parentId: null)
```

### í•µì‹¬ ê°œë…

| ê°œë… | ì„¤ëª… |
|------|------|
| **parentId** | ë¶€ëª¨ ëŒ“ê¸€ ID. nullì´ë©´ ìµœìƒìœ„ ëŒ“ê¸€, ê°’ì´ ìˆìœ¼ë©´ ëŒ€ëŒ“ê¸€ |
| **ì†Œí”„íŠ¸ ì‚­ì œ** | DBì—ì„œ ì‹¤ì œë¡œ ì‚­ì œí•˜ì§€ ì•Šê³  `isDeleted=true`ë¡œ í‘œì‹œ |
| **ì¢‹ì•„ìš” í† ê¸€** | ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥´ë©´ í™œì„±í™”, ë‹¤ì‹œ ëˆ„ë¥´ë©´ í•´ì œ (unlike) |
| **ìµëª… ID** | ìµëª… ê²Œì‹œíŒì—ì„œ ì‚¬ìš©ì ID ëŒ€ì‹  í‘œì‹œë˜ëŠ” ë²ˆí˜¸ |

---

## 2. ë°±ì—”ë“œ êµ¬í˜„

### 2.1 Comment ì—”í‹°í‹°

> **íŒŒì¼ ìœ„ì¹˜**: `backend/src/main/java/com/ej2/model/Comment.java`

```java
@Entity
@Table(name = "comments")
public class Comment {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "post_id", nullable = false)
    private Long postId;          // ì†Œì† ê²Œì‹œê¸€

    @Column(name = "user_id", nullable = false)
    private Long userId;          // ì‘ì„±ì

    @Column(name = "parent_id")
    private Long parentId;        // ë¶€ëª¨ ëŒ“ê¸€ ID (ëŒ€ëŒ“ê¸€ì´ë©´ ê°’ ìˆìŒ)

    @Column(columnDefinition = "TEXT", nullable = false)
    private String content;       // ëŒ“ê¸€ ë‚´ìš©

    @Column(name = "anonymous_id")
    private String anonymousId;   // ìµëª… ê²Œì‹œíŒì—ì„œì˜ ìµëª… ID

    @Column(name = "like_count")
    private Integer likeCount = 0;     // ì¢‹ì•„ìš” ìˆ˜

    @Column(name = "dislike_count")
    private Integer dislikeCount = 0;  // ì‹«ì–´ìš” ìˆ˜

    @Column(name = "is_deleted")
    private Boolean isDeleted = false; // ì‚­ì œ ì—¬ë¶€ (ì†Œí”„íŠ¸ ì‚­ì œ)

    @Transient
    private boolean refreshUpdatedAt = true;  // updatedAt ê°±ì‹  ì œì–´
}
```

#### í…Œì´ë¸” ê´€ê³„

```
posts                       comments
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id (PK)     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ post_id (FK)     â”‚
â”‚ title       â”‚    1:N     â”‚ id (PK)          â”‚
â”‚ content     â”‚            â”‚ user_id          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚ parent_id â”€â”€â”€â”   â”‚  â† ìê¸° ì°¸ì¡°!
                           â”‚ content      â”‚   â”‚
                           â”‚ is_deleted   â”‚   â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                                    â†‘         â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              (ëŒ€ëŒ“ê¸€ì´ ë¶€ëª¨ ëŒ“ê¸€ì„ ì°¸ì¡°)
```

### 2.2 CommentDTO

```java
public class CommentDTO {
    private Long id;
    private Long postId;
    private Long userId;
    private Long parentId;
    private String content;
    private String authorName;     // â† ì‘ì„±ì ì´ë¦„ (ë˜ëŠ” ìµëª… ID)
    private String anonymousId;
    private Integer likeCount;
    private Boolean isDeleted;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
}
```

**Entity â†’ DTO ë³€í™˜ ì‹œ ì²˜ë¦¬**:
```
ì¼ë°˜ ê²Œì‹œíŒ:
  authorName = user.getName()  â†’ "ê¹€ì² ìˆ˜"

ìµëª… ê²Œì‹œíŒ:
  authorName = comment.getAnonymousId()  â†’ "åŒ¿å3"

ì‚­ì œëœ ëŒ“ê¸€:
  content = "(å‰Šé™¤ã•ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆã§ã™)"  â†’ ë‚´ìš© ìˆ¨ê¹€
  authorName = null  â†’ ì‘ì„±ì ìˆ¨ê¹€
```

### 2.3 CommentService (ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§)

> **íŒŒì¼ ìœ„ì¹˜**: `backend/src/main/java/com/ej2/service/CommentService.java`

#### ëŒ“ê¸€ ìƒì„±

```java
public Comment createComment(Comment comment) {
    // 1. ì‚­ì œëœ ëŒ“ê¸€ì— ëŒ€ëŒ“ê¸€ ë°©ì§€
    if (comment.getParentId() != null) {
        Comment parent = commentRepository.findById(comment.getParentId());
        if (parent != null && Boolean.TRUE.equals(parent.getIsDeleted())) {
            throw new RuntimeException("å‰Šé™¤ã•ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆã«ã¯è¿”ä¿¡ã§ãã¾ã›ã‚“");
        }
    }

    // 2. ìµëª… ê²Œì‹œíŒì´ë©´ ìµëª… ID ë¶€ì—¬
    Post post = postRepository.findById(comment.getPostId());
    Board board = boardRepository.findById(post.getBoardId());

    if (board != null && Boolean.TRUE.equals(board.getIsAnonymous())) {
        // ì´ ê²Œì‹œíŒì—ì„œ ì´ ì‚¬ìš©ìì˜ ê¸°ì¡´ ìµëª… ID í™•ì¸
        String existingAnonymousId = commentRepository
            .findAnonymousIdByPostBoardAndUser(post.getBoardId(), comment.getUserId());

        if (existingAnonymousId != null) {
            comment.setAnonymousId(existingAnonymousId);  // ê¸°ì¡´ ID ì¬ì‚¬ìš©
        } else {
            // ìƒˆ ìµëª… ID ë¶€ì—¬
            long uniqueUsers = commentRepository
                .countDistinctUserIdByBoardId(post.getBoardId());
            comment.setAnonymousId("åŒ¿å" + (uniqueUsers + 1));
        }
    }

    // 3. ì €ì¥ + ê²Œì‹œê¸€ì˜ commentCount ì¦ê°€
    Comment saved = commentRepository.save(comment);
    post.setCommentCount(post.getCommentCount() + 1);
    post.setRefreshUpdatedAt(false);
    postRepository.save(post);

    return saved;
}
```

#### ì¢‹ì•„ìš” í† ê¸€ (ëˆ„ë¥´ë©´ ì¼œê¸°, ë‹¤ì‹œ ëˆ„ë¥´ë©´ ë„ê¸°)

```java
public boolean toggleLike(Long commentId, Long userId) {
    // ì´ë¯¸ ì¢‹ì•„ìš” í–ˆëŠ”ì§€ í™•ì¸
    CommentLikeLog existing = commentLikeLogRepository
        .findByCommentIdAndUserId(commentId, userId);

    Comment comment = commentRepository.findById(commentId);
    comment.setRefreshUpdatedAt(false);

    if (existing != null) {
        // ì´ë¯¸ ì¢‹ì•„ìš” â†’ ì·¨ì†Œ (unlike)
        commentLikeLogRepository.delete(existing);
        comment.setLikeCount(Math.max(0, comment.getLikeCount() - 1));
        commentRepository.save(comment);
        return false;  // "ì¢‹ì•„ìš” ì·¨ì†Œë¨"
    } else {
        // ì•„ì§ ì¢‹ì•„ìš” ì•ˆ í•¨ â†’ ì¢‹ì•„ìš”
        CommentLikeLog log = new CommentLikeLog(commentId, userId);
        commentLikeLogRepository.save(log);
        comment.setLikeCount(comment.getLikeCount() + 1);
        commentRepository.save(comment);
        return true;   // "ì¢‹ì•„ìš” ë¨"
    }
}
```

**í† ê¸€ íŒ¨í„´ ì„¤ëª…**:
```
ì²« ë²ˆì§¸ í´ë¦­: ì¢‹ì•„ìš” ê¸°ë¡ ì—†ìŒ â†’ ê¸°ë¡ ì¶”ê°€ + count +1 â†’ â¤ï¸ (ë¹¨ê°„ìƒ‰)
ë‘ ë²ˆì§¸ í´ë¦­: ì¢‹ì•„ìš” ê¸°ë¡ ìˆìŒ â†’ ê¸°ë¡ ì‚­ì œ + count -1 â†’ ğŸ¤ (íšŒìƒ‰)
ì„¸ ë²ˆì§¸ í´ë¦­: ì¢‹ì•„ìš” ê¸°ë¡ ì—†ìŒ â†’ ê¸°ë¡ ì¶”ê°€ + count +1 â†’ â¤ï¸ (ë¹¨ê°„ìƒ‰)
...
```

**Math.max(0, count - 1)**: ì¢‹ì•„ìš” ìˆ˜ê°€ ìŒìˆ˜ê°€ ë˜ì§€ ì•Šë„ë¡ ë³´í˜¸

#### ì†Œí”„íŠ¸ ì‚­ì œ

```java
public void deleteComment(Long commentId) {
    Comment comment = commentRepository.findById(commentId);

    // ì‹¤ì œ ì‚­ì œê°€ ì•„ë‹Œ "ì‚­ì œë¨" í‘œì‹œ
    comment.setIsDeleted(true);
    comment.setContent("(å‰Šé™¤ã•ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆã§ã™)");
    commentRepository.save(comment);

    // ê²Œì‹œê¸€ì˜ commentCount ê°ì†Œ
    Post post = postRepository.findById(comment.getPostId());
    post.setCommentCount(Math.max(0, post.getCommentCount() - 1));
    post.setRefreshUpdatedAt(false);
    postRepository.save(post);
}
```

### 2.4 CommentController (API)

> **íŒŒì¼ ìœ„ì¹˜**: `backend/src/main/java/com/ej2/controller/CommentController.java`

#### ì „ì²´ API ëª©ë¡

| ë©”ì„œë“œ | URL | ì„¤ëª… |
|--------|-----|------|
| GET | `/api/comments/post/{postId}` | ê²Œì‹œê¸€ì˜ ì „ì²´ ëŒ“ê¸€ |
| GET | `/api/comments/post/{postId}/top` | ìµœìƒìœ„ ëŒ“ê¸€ë§Œ |
| GET | `/api/comments/{id}/replies` | íŠ¹ì • ëŒ“ê¸€ì˜ ëŒ€ëŒ“ê¸€ |
| POST | `/api/comments` | ëŒ“ê¸€ ì‘ì„± |
| PUT | `/api/comments/{id}` | ëŒ“ê¸€ ìˆ˜ì • (ë³¸ì¸ë§Œ) |
| DELETE | `/api/comments/{id}` | ëŒ“ê¸€ ì‚­ì œ (ë³¸ì¸ë§Œ) |
| POST | `/api/comments/{id}/like` | ì¢‹ì•„ìš” í† ê¸€ |
| GET | `/api/comments/{id}/like/check` | ì¢‹ì•„ìš” ì—¬ë¶€ í™•ì¸ |
| GET | `/api/comments/post/{postId}/count` | ëŒ“ê¸€ ìˆ˜ |

---

## 3. í”„ë¡ íŠ¸ì—”ë“œ êµ¬í˜„

### 3.1 CommentSection ì»´í¬ë„ŒíŠ¸

> **íŒŒì¼ ìœ„ì¹˜**: `frontend/src/pages/Board/CommentSection.js`

PostDetailPage ì•ˆì— í¬í•¨ë˜ì–´ ì‚¬ìš©ë©ë‹ˆë‹¤.

```jsx
// PostDetailPage.jsì—ì„œ ì‚¬ìš©
<CommentSection postId={postId} boardId={boardId} />
```

```javascript
function CommentSection({ postId, boardId }) {
    const [comments, setComments] = useState([]);      // ì „ì²´ ëŒ“ê¸€
    const [newComment, setNewComment] = useState('');   // ìƒˆ ëŒ“ê¸€ ì…ë ¥
    const [replyTo, setReplyTo] = useState(null);       // ëŒ€ëŒ“ê¸€ ëŒ€ìƒ
    const [replyContent, setReplyContent] = useState(''); // ëŒ€ëŒ“ê¸€ ì…ë ¥
    const [editingId, setEditingId] = useState(null);    // ìˆ˜ì • ì¤‘ì¸ ëŒ“ê¸€ ID
    const [editContent, setEditContent] = useState('');   // ìˆ˜ì • ë‚´ìš©
    const [likedComments, setLikedComments] = useState(new Set()); // ì¢‹ì•„ìš”í•œ ëŒ“ê¸€ Set

    const currentUser = JSON.parse(localStorage.getItem('user'));

    useEffect(() => {
        loadComments();
    }, [postId]);
}
```

**Setì„ ì‚¬ìš©í•˜ëŠ” ì´ìœ  (likedComments)**:
```javascript
// Arrayë¡œ ê´€ë¦¬í•˜ë©´:
const likedComments = [1, 5, 12];
likedComments.includes(5);  // O(n) - ë°°ì—´ ì „ì²´ë¥¼ ìˆœíšŒ

// Setìœ¼ë¡œ ê´€ë¦¬í•˜ë©´:
const likedComments = new Set([1, 5, 12]);
likedComments.has(5);       // O(1) - ì¦‰ì‹œ í™•ì¸!

ëŒ“ê¸€ì´ 100ê°œì¼ ë•Œ, ê° ëŒ“ê¸€ë§ˆë‹¤ ì¢‹ì•„ìš” ì—¬ë¶€ë¥¼ í™•ì¸í•˜ë©´:
Array: 100 Ã— 100 = 10,000ë²ˆ ì—°ì‚°
Set: 100 Ã— 1 = 100ë²ˆ ì—°ì‚°
```

### 3.2 ëŒ“ê¸€ ì‘ì„± í¼

```javascript
const handleSubmitComment = async () => {
    if (!newComment.trim()) return;

    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) {
        alert('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
        return;
    }

    await axios.post('/api/comments', {
        postId: postId,
        userId: user.id,
        content: newComment.trim(),
        parentId: null  // ìµœìƒìœ„ ëŒ“ê¸€ (ëŒ€ëŒ“ê¸€ì´ ì•„ë‹˜)
    }, { withCredentials: true });

    setNewComment('');    // ì…ë ¥ ì´ˆê¸°í™”
    loadComments();       // ëŒ“ê¸€ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
};
```

```jsx
<div className="comment-form">
    <textarea
        placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›..."
        value={newComment}
        onChange={(e) => setNewComment(e.target.value)}
        maxLength={1000}
    />
    <button onClick={handleSubmitComment}>
        æŠ•ç¨¿
    </button>
</div>
```

### 3.3 ëŒ€ëŒ“ê¸€ êµ¬í˜„

#### ëŒ€ëŒ“ê¸€ ë²„íŠ¼ í´ë¦­

```javascript
const handleReply = (commentId) => {
    if (replyTo === commentId) {
        setReplyTo(null);           // ì´ë¯¸ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê¸°
        setReplyContent('');
    } else {
        setReplyTo(commentId);      // ëŒ€ëŒ“ê¸€ í¼ ì—´ê¸°
    }
};
```

#### ëŒ€ëŒ“ê¸€ ì œì¶œ

```javascript
const handleSubmitReply = async (parentId) => {
    if (!replyContent.trim()) return;

    await axios.post('/api/comments', {
        postId: postId,
        userId: currentUser.id,
        content: replyContent.trim(),
        parentId: parentId  // â† ë¶€ëª¨ ëŒ“ê¸€ ID ì§€ì •!
    }, { withCredentials: true });

    setReplyTo(null);
    setReplyContent('');
    loadComments();
};
```

#### ëŒ“ê¸€ ë Œë”ë§ (ì¤‘ì²© êµ¬ì¡°)

```jsx
{comments
    .filter(c => c.parentId === null)     // ìµœìƒìœ„ ëŒ“ê¸€ë§Œ í•„í„°ë§
    .map(comment => (
        <div key={comment.id} className="comment-item">
            {/* ìµœìƒìœ„ ëŒ“ê¸€ í‘œì‹œ */}
            <CommentItem comment={comment} />

            {/* ëŒ€ëŒ“ê¸€ ëª©ë¡ */}
            <div className="replies" style={{ marginLeft: '40px' }}>
                {comments
                    .filter(reply => reply.parentId === comment.id)  // ì´ ëŒ“ê¸€ì˜ ëŒ€ëŒ“ê¸€
                    .map(reply => (
                        <div key={reply.id} className="reply-item">
                            <CommentItem comment={reply} isReply={true} />
                        </div>
                    ))
                }
            </div>

            {/* ëŒ€ëŒ“ê¸€ ì…ë ¥ í¼ */}
            {replyTo === comment.id && (
                <div className="reply-form">
                    <textarea
                        value={replyContent}
                        onChange={(e) => setReplyContent(e.target.value)}
                        placeholder="è¿”ä¿¡ã‚’å…¥åŠ›..."
                    />
                    <button onClick={() => handleSubmitReply(comment.id)}>
                        è¿”ä¿¡
                    </button>
                </div>
            )}
        </div>
    ))
}
```

**ì¤‘ì²© ëŒ“ê¸€ ë Œë”ë§ ê³¼ì •**:
```
ì „ì²´ ëŒ“ê¸€: [
  {id:1, parentId:null, content:"ì¢‹ì€ ê¸€!"},
  {id:2, parentId:null, content:"ê°ì‚¬í•©ë‹ˆë‹¤"},
  {id:3, parentId:1, content:"ë™ì˜í•´ìš”"},
  {id:4, parentId:1, content:"ì €ë„ìš”"},
  {id:5, parentId:2, content:"ë³„ë§ì”€ì„"}
]

1. ìµœìƒìœ„ ëŒ“ê¸€ í•„í„°ë§ (parentId === null):
   [ëŒ“ê¸€1, ëŒ“ê¸€2]

2. ê° ëŒ“ê¸€ì— ëŒ€í•´ ëŒ€ëŒ“ê¸€ í•„í„°ë§:
   ëŒ“ê¸€1ì˜ ëŒ€ëŒ“ê¸€ (parentId === 1): [ëŒ“ê¸€3, ëŒ“ê¸€4]
   ëŒ“ê¸€2ì˜ ëŒ€ëŒ“ê¸€ (parentId === 2): [ëŒ“ê¸€5]

3. ìµœì¢… ë Œë”ë§:
   ëŒ“ê¸€1: "ì¢‹ì€ ê¸€!"
     â””â”€â”€ ëŒ“ê¸€3: "ë™ì˜í•´ìš”"
     â””â”€â”€ ëŒ“ê¸€4: "ì €ë„ìš”"
   ëŒ“ê¸€2: "ê°ì‚¬í•©ë‹ˆë‹¤"
     â””â”€â”€ ëŒ“ê¸€5: "ë³„ë§ì”€ì„"
```

### 3.4 ì¢‹ì•„ìš” í† ê¸€

```javascript
const handleLikeComment = async (commentId) => {
    if (!currentUser) {
        alert('ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
        return;
    }

    try {
        const response = await axios.post(
            `/api/comments/${commentId}/like`,
            {},
            { withCredentials: true }
        );

        // response.data = { liked: true/false, likeCount: 5 }

        if (response.data.liked) {
            // ì¢‹ì•„ìš” ì¶”ê°€ë¨
            setLikedComments(prev => new Set([...prev, commentId]));
        } else {
            // ì¢‹ì•„ìš” ì·¨ì†Œë¨
            setLikedComments(prev => {
                const next = new Set(prev);
                next.delete(commentId);
                return next;
            });
        }

        loadComments();  // ëŒ“ê¸€ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
    } catch (err) {
        console.error('Like error:', err);
    }
};
```

#### ì¢‹ì•„ìš” ìƒíƒœ ì´ˆê¸° ë¡œë“œ

```javascript
// ëŒ“ê¸€ ëª©ë¡ ë¡œë“œ ì‹œ ê° ëŒ“ê¸€ì˜ ì¢‹ì•„ìš” ìƒíƒœë„ í™•ì¸
const loadComments = async () => {
    const response = await axios.get(`/api/comments/post/${postId}`);
    setComments(response.data);

    // ë¡œê·¸ì¸ ìƒíƒœë©´ ì¢‹ì•„ìš” ìƒíƒœ í™•ì¸
    if (currentUser) {
        const likedSet = new Set();
        for (const comment of response.data) {
            const likeRes = await axios.get(
                `/api/comments/${comment.id}/like/check`,
                { withCredentials: true }
            );
            if (likeRes.data.liked) {
                likedSet.add(comment.id);
            }
        }
        setLikedComments(likedSet);
    }
};
```

```jsx
{/* ì¢‹ì•„ìš” ë²„íŠ¼ */}
<button
    className={`like-button ${likedComments.has(comment.id) ? 'liked' : ''}`}
    onClick={() => handleLikeComment(comment.id)}
>
    {likedComments.has(comment.id) ? 'â¤ï¸' : 'ğŸ¤'} {comment.likeCount}
</button>
```

### 3.5 ìˆ˜ì •/ì‚­ì œ ê¸°ëŠ¥

#### ëŒ“ê¸€ ìˆ˜ì •

```javascript
const handleEditComment = async (commentId) => {
    if (!editContent.trim()) return;

    await axios.put(`/api/comments/${commentId}`, {
        content: editContent.trim()
    }, { withCredentials: true });

    setEditingId(null);
    setEditContent('');
    loadComments();
};
```

```jsx
{editingId === comment.id ? (
    // ìˆ˜ì • ëª¨ë“œ
    <div className="edit-form">
        <textarea
            value={editContent}
            onChange={(e) => setEditContent(e.target.value)}
        />
        <button onClick={() => handleEditComment(comment.id)}>ä¿å­˜</button>
        <button onClick={() => setEditingId(null)}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
) : (
    // í‘œì‹œ ëª¨ë“œ
    <p className="comment-content">{comment.content}</p>
)}
```

#### ëŒ“ê¸€ ì‚­ì œ

```javascript
const handleDeleteComment = async (commentId) => {
    if (!window.confirm('ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

    await axios.delete(`/api/comments/${commentId}`, {
        withCredentials: true
    });

    loadComments();
};
```

#### ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ (ë³¸ì¸ë§Œ í‘œì‹œ)

```jsx
{currentUser && currentUser.id === comment.userId && !comment.isDeleted && (
    <div className="comment-actions">
        <button onClick={() => {
            setEditingId(comment.id);
            setEditContent(comment.content);
        }}>
            ç·¨é›†
        </button>
        <button onClick={() => handleDeleteComment(comment.id)}>
            å‰Šé™¤
        </button>
    </div>
)}
```

**ì¡°ê±´ ë¶„ì„**:
```
currentUser                              â†’ ë¡œê·¸ì¸ ìƒíƒœ
&& currentUser.id === comment.userId     â†’ ë³¸ì¸ ëŒ“ê¸€
&& !comment.isDeleted                    â†’ ì•„ì§ ì‚­ì œë˜ì§€ ì•Šì€ ëŒ“ê¸€
â†’ ì„¸ ì¡°ê±´ ëª¨ë‘ ë§Œì¡±í•´ì•¼ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
```

---

## 4. ëŒ€ëŒ“ê¸€ ë°ì´í„° êµ¬ì¡°

### ë‹¨ì¼ í…Œì´ë¸” ìê¸° ì°¸ì¡° íŒ¨í„´

```sql
comments í…Œì´ë¸”:
| id | post_id | parent_id | content          | is_deleted |
|----|---------|-----------|------------------|------------|
| 1  | 10      | NULL      | "ì¢‹ì€ ê¸€!"       | false      |
| 2  | 10      | NULL      | "ê°ì‚¬í•©ë‹ˆë‹¤"     | false      |
| 3  | 10      | 1         | "ë™ì˜í•´ìš”"       | false      |
| 4  | 10      | 1         | "ì €ë„ìš”"         | false      |
| 5  | 10      | 2         | "ë³„ë§ì”€ì„"       | false      |
```

- `parent_id = NULL` â†’ ìµœìƒìœ„ ëŒ“ê¸€
- `parent_id = 1` â†’ ëŒ“ê¸€ 1ë²ˆì— ëŒ€í•œ ëŒ€ëŒ“ê¸€

**ì´ êµ¬ì¡°ì˜ ì¥ì **:
- í…Œì´ë¸” í•˜ë‚˜ë¡œ ëª¨ë“  ëŒ“ê¸€ ê´€ë¦¬
- ì¿¼ë¦¬ê°€ ë‹¨ìˆœí•¨
- 2ë‹¨ê³„ê¹Œì§€ì˜ ì¤‘ì²©ì— ì í•© (ëŒ“ê¸€ â†’ ëŒ€ëŒ“ê¸€)

**ì´ êµ¬ì¡°ì˜ ì œí•œ**:
- 3ë‹¨ê³„ ì´ìƒ ì¤‘ì²©ì€ ë³µì¡í•´ì§ (ëŒ€ëŒ€ëŒ“ê¸€)
- ì´ í”„ë¡œì íŠ¸ì—ì„œëŠ” 2ë‹¨ê³„ê¹Œì§€ë§Œ ì§€ì›

---

## 5. ì†Œí”„íŠ¸ ì‚­ì œ vs í•˜ë“œ ì‚­ì œ

### í•˜ë“œ ì‚­ì œ (Hard Delete)

```sql
DELETE FROM comments WHERE id = 3;
-- ëŒ“ê¸€ì´ DBì—ì„œ ì™„ì „íˆ ì‚¬ë¼ì§
```

**ë¬¸ì œì **: ëŒ€ëŒ“ê¸€ì´ ìˆëŠ” ëŒ“ê¸€ì„ ì‚­ì œí•˜ë©´ ëŒ€ëŒ“ê¸€ì´ ê³ ì•„(orphan)ê°€ ë¨

### ì†Œí”„íŠ¸ ì‚­ì œ (Soft Delete) - í˜„ì¬ ë°©ì‹

```java
comment.setIsDeleted(true);
comment.setContent("(å‰Šé™¤ã•ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆã§ã™)");
commentRepository.save(comment);
```

```sql
-- DB:
| id | content                    | is_deleted |
|----|----------------------------|------------|
| 1  | (å‰Šé™¤ã•ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆã§ã™)    | true       |
| 3  | "ë™ì˜í•´ìš”"                  | false      |  â† ëŒ€ëŒ“ê¸€ì€ ìœ ì§€!
```

**í™”ë©´ í‘œì‹œ**:
```
[ì‚­ì œëœ ëŒ“ê¸€ì…ë‹ˆë‹¤]
  â””â”€â”€ ë™ì˜í•´ìš”
```

**ì†Œí”„íŠ¸ ì‚­ì œì˜ ì¥ì **:
- ëŒ€ëŒ“ê¸€ êµ¬ì¡°ê°€ ìœ ì§€ë¨
- ì‹¤ìˆ˜ë¡œ ì‚­ì œí•´ë„ DBì—ì„œ ë³µêµ¬ ê°€ëŠ¥ (ê´€ë¦¬ì)
- ëŒ“ê¸€ ìˆ˜ í†µê³„ ì •í™•ì„± ìœ ì§€

---

## 6. ìµëª… ëŒ“ê¸€ ì‹œìŠ¤í…œ

### ìµëª… ê²Œì‹œíŒì—ì„œì˜ ëŒ“ê¸€ ì²˜ë¦¬

```
ì‚¬ìš©ì Aê°€ ìµëª… ê²Œì‹œíŒì—ì„œ ê²Œì‹œê¸€ ì‘ì„± â†’ "åŒ¿å1"
ì‚¬ìš©ì Aê°€ ê°™ì€ ê²Œì‹œíŒì—ì„œ ëŒ“ê¸€ ì‘ì„± â†’ "åŒ¿å1" (ê°™ì€ ID!)
ì‚¬ìš©ì Bê°€ ê°™ì€ ê²Œì‹œíŒì—ì„œ ëŒ“ê¸€ ì‘ì„± â†’ "åŒ¿å2"
ì‚¬ìš©ì Aê°€ ë‹¤ë¥¸ ê²Œì‹œê¸€ì—ë„ ëŒ“ê¸€ ì‘ì„± â†’ "åŒ¿å1" (ê²Œì‹œíŒ ë‹¨ìœ„ë¡œ ì¼ê´€)
```

**ê·œì¹™**:
1. ê°™ì€ ì‚¬ìš©ì + ê°™ì€ ê²Œì‹œíŒ â†’ í•­ìƒ ê°™ì€ ìµëª… ID
2. ê²Œì‹œê¸€ì˜ ì‘ì„±ìì™€ ëŒ“ê¸€ì˜ ì‘ì„±ìê°€ ê°™ìœ¼ë©´ ê°™ì€ ìµëª… ID
3. í”„ë¡ íŠ¸ì—”ë“œì—ì„œëŠ” `anonymousId`ê°€ ìˆìœ¼ë©´ ì‹¤ëª… ëŒ€ì‹  í‘œì‹œ

```jsx
<span className="comment-author">
    {comment.anonymousId ? (
        <span className="anonymous-badge">ğŸ­ {comment.anonymousId}</span>
    ) : (
        comment.authorName
    )}
</span>
```

---

## 7. ìì£¼ ë°œìƒí•˜ëŠ” ì—ëŸ¬ì™€ í•´ê²°ë²•

### ì—ëŸ¬ 1: ëŒ“ê¸€ ì‘ì„± ì‹œ 403 Forbidden

**ì›ì¸**: SecurityConfigì—ì„œ POST /api/commentsì— ì¸ì¦ í•„ìš”

**í•´ê²°**: ë¡œê·¸ì¸ í™•ì¸ + `withCredentials: true` ì˜µì…˜

### ì—ëŸ¬ 2: ëŒ€ëŒ“ê¸€ì´ í‘œì‹œ ì•ˆ ë¨

**ì›ì¸**: í•„í„°ë§ ë¡œì§ì—ì„œ parentId ë¹„êµ ì˜¤ë¥˜

**í™•ì¸**:
```javascript
// ìµœìƒìœ„ ëŒ“ê¸€ë§Œ
comments.filter(c => c.parentId === null)  // nullì´ì–´ì•¼ í•¨ (undefined X)

// íŠ¹ì • ëŒ“ê¸€ì˜ ëŒ€ëŒ“ê¸€
comments.filter(c => c.parentId === comment.id)
```

### ì—ëŸ¬ 3: ì¢‹ì•„ìš” ìƒíƒœê°€ ìƒˆë¡œê³ ì¹¨í•˜ë©´ ì´ˆê¸°í™”

**ì›ì¸**: ì¢‹ì•„ìš” ìƒíƒœë¥¼ í˜ì´ì§€ ë¡œë“œ ì‹œ ì„œë²„ì—ì„œ ë‹¤ì‹œ í™•ì¸í•˜ì§€ ì•ŠìŒ

**í•´ê²°**: `loadComments`ì—ì„œ ê° ëŒ“ê¸€ì˜ `/like/check` API í˜¸ì¶œ

### ì—ëŸ¬ 4: ì‚­ì œëœ ëŒ“ê¸€ì¸ë° ëŒ€ëŒ“ê¸€ ë‹¬ë¦¼

**ì›ì¸**: ì„œë²„ì—ì„œ ì‚­ì œëœ ëŒ“ê¸€ì— ëŒ€ëŒ“ê¸€ ë°©ì§€ ë¡œì§ ëˆ„ë½

**í•´ê²°**: `createComment`ì—ì„œ ë¶€ëª¨ ëŒ“ê¸€ì˜ `isDeleted` í™•ì¸
```java
if (parent != null && Boolean.TRUE.equals(parent.getIsDeleted())) {
    throw new RuntimeException("å‰Šé™¤ã•ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆã«ã¯è¿”ä¿¡ã§ãã¾ã›ã‚“");
}
```

### ì—ëŸ¬ 5: ëŒ“ê¸€ ìˆ˜ì™€ ì‹¤ì œ ëŒ“ê¸€ì´ ì•ˆ ë§ìŒ

**ì›ì¸**: ëŒ“ê¸€ ìƒì„±/ì‚­ì œ ì‹œ Postì˜ commentCount ë™ê¸°í™” ì‹¤íŒ¨

**í™•ì¸**:
```sql
-- ì‹¤ì œ ëŒ“ê¸€ ìˆ˜
SELECT COUNT(*) FROM comments WHERE post_id = 10 AND is_deleted = false;

-- ê²Œì‹œê¸€ì— ê¸°ë¡ëœ ëŒ“ê¸€ ìˆ˜
SELECT comment_count FROM posts WHERE id = 10;
```

### ì—ëŸ¬ 6: "ìˆ˜ì •ë¨" í‘œì‹œê°€ ì¢‹ì•„ìš”ë§Œ ëˆŒëŸ¬ë„ ë‚˜íƒ€ë‚¨

**ì›ì¸**: `refreshUpdatedAt = false` ì„¤ì •ì´ ëˆ„ë½ë¨

**í•´ê²°**: ì¢‹ì•„ìš”/ì¡°íšŒìˆ˜ ë³€ê²½ ì‹œ ë°˜ë“œì‹œ ì„¤ì •:
```java
comment.setRefreshUpdatedAt(false);
comment.setLikeCount(comment.getLikeCount() + 1);
commentRepository.save(comment);
```

---

> ì´ì „ ë¬¸ì„œ: [06. ê¸°ë³¸ ê²Œì‹œíŒ CRUD êµ¬í˜„ ê°€ì´ë“œ](./06_ê²Œì‹œíŒ_CRUD_êµ¬í˜„_ê°€ì´ë“œ.md)
>
> ğŸ“š **ì „ì²´ ë¬¸ì„œ ëª©ì°¨**:
> 1. [ë¡œê·¸ì¸ í˜ì´ì§€](./01_ë¡œê·¸ì¸_í˜ì´ì§€_êµ¬í˜„_ê°€ì´ë“œ.md)
> 2. [ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°](./02_ì•„ì´ë””_ë¹„ë°€ë²ˆí˜¸_ì°¾ê¸°_êµ¬í˜„_ê°€ì´ë“œ.md)
> 3. [ì‹œê°„í‘œ í˜ì´ì§€](./03_ì‹œê°„í‘œ_í˜ì´ì§€_êµ¬í˜„_ê°€ì´ë“œ.md)
> 4. [ê´€ë¦¬ì/ì‹ ê³  í˜ì´ì§€](./04_ê´€ë¦¬ì_ì‹ ê³ _í˜ì´ì§€_êµ¬í˜„_ê°€ì´ë“œ.md)
> 5. [ì±„íŒ…ë°©](./05_ì±„íŒ…ë°©_êµ¬í˜„_ê°€ì´ë“œ.md)
> 6. [ê²Œì‹œíŒ CRUD](./06_ê²Œì‹œíŒ_CRUD_êµ¬í˜„_ê°€ì´ë“œ.md)
> 7. [ëŒ“ê¸€ ê¸°ëŠ¥](./07_ëŒ“ê¸€_ê¸°ëŠ¥_êµ¬í˜„_ê°€ì´ë“œ.md) â† í˜„ì¬ ë¬¸ì„œ
