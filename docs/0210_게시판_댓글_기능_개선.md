# 게시판 및 댓글 기능 개선 (2026-02-10)

## 개요
게시판과 댓글 시스템의 사용자 경험을 개선하기 위해 세 가지 주요 기능을 수정했습니다.

---

## 변경 사항

### 1. 게시글 좋아요/싫어요 - 1회 제한 (영구)

#### 변경 전
- 로그인/비로그인 사용자 모두 **24시간마다 1회** 좋아요/싫어요 가능
- 시간이 지나면 다시 좋아요/싫어요 할 수 있었음

#### 변경 후
- 로그인/비로그인 사용자 모두 **게시글당 영구적으로 1회만** 가능
- 한 번 좋아요/싫어요를 누르면 다시 누를 수 없음
- 로그인 사용자: userId 기반으로 중복 체크
- 비로그인 사용자: IP 주소 기반으로 중복 체크

#### 수정된 파일
```
backend/src/main/java/com/ej2/service/PostService.java
  - incrementLikeCount() 메서드 수정
  - incrementDislikeCount() 메서드 수정

backend/src/main/java/com/ej2/repository/PostLikeLogRepository.java
  - findByPostIdAndUserId() 추가
  - findByPostIdAndIpAddress() 추가

backend/src/main/java/com/ej2/repository/PostDislikeLogRepository.java
  - findByPostIdAndUserId() 추가
  - findByPostIdAndIpAddress() 추가
```

#### 기술적 세부사항
**PostService.java - incrementLikeCount() 변경 내용:**
```java
// 변경 전: 24시간 기반 체크
LocalDateTime oneDayAgo = LocalDateTime.now().minusDays(1);
List<PostLikeLog> userLikeLogs = postLikeLogRepository
    .findByPostIdAndUserIdAndLikedAtAfter(postId, userId, oneDayAgo);

// 변경 후: 시간 무관 체크
List<PostLikeLog> userLikeLogs = postLikeLogRepository
    .findByPostIdAndUserId(postId, userId);
```

**동작 원리:**
1. 사용자가 좋아요 버튼 클릭
2. `PostLikeLog` 테이블에서 해당 사용자(또는 IP)의 좋아요 이력 조회
3. 이력이 **하나라도 있으면** 좋아요 수 증가 차단
4. 이력이 없으면 좋아요 수 증가 + 로그 저장

---

### 2. 댓글 타임스탬프 표시 개선

#### 변경 전
- 1분 미만 댓글: "たった今" (방금 전) 표시
- 수정된 댓글: "（編集済み）" (수정됨) 표시

#### 변경 후
- 1분 미만 댓글: "**0分前**" (0분 전) 표시
- 수정된 댓글: 수정됨 표시 **완전 제거**

#### 수정된 파일
```
frontend/src/pages/Board/CommentSection.js
  - getTimeAgo() 함수 수정
  - 수정됨 표시 로직 제거
```

#### 기술적 세부사항
**getTimeAgo() 함수 변경:**
```javascript
// 변경 전
const getTimeAgo = (dateString) => {
    const diffInMinutes = Math.floor((now - past) / (1000 * 60));
    if (diffInMinutes < 1) return 'たった今';  // ← 제거됨
    if (diffInMinutes < 60) return `${diffInMinutes}分前`;
    // ...
};

// 변경 후
const getTimeAgo = (dateString) => {
    const diffInMinutes = Math.floor((now - past) / (1000 * 60));
    if (diffInMinutes < 60) return `${diffInMinutes}分前`;  // 0분부터 표시
    // ...
};
```

**수정됨 표시 제거:**
```jsx
{/* 변경 전: 수정됨 표시 조건부 렌더링 */}
{comment.updatedAt && comment.createdAt &&
 new Date(comment.updatedAt).getTime() - new Date(comment.createdAt).getTime() > 1000 && (
  <span className="comment-time">（編集済み）</span>
)}

{/* 변경 후: 완전 제거 */}
```

---

### 3. 댓글 삭제 - 하드 삭제 + 자식 댓글 고아화

#### 변경 전 (소프트 삭제)
- `isDeleted` 플래그를 `true`로 설정
- 댓글 내용을 "削除されたコメントです。"로 변경
- 데이터베이스에 댓글 데이터 유지
- 대댓글(자식 댓글)은 그대로 유지

#### 변경 후 (하드 삭제)
- 댓글을 **데이터베이스에서 완전히 삭제**
- 대댓글(자식 댓글)의 `parentId`를 `null`로 설정 (고아화)
- 삭제된 댓글의 모든 좋아요 로그도 함께 삭제
- 대댓글은 최상위 댓글로 승격

#### 수정된 파일
```
backend/src/main/java/com/ej2/service/CommentService.java
  - deleteComment() 메서드 완전히 재작성

backend/src/main/java/com/ej2/repository/CommentLikeLogRepository.java
  - deleteByCommentId() 메서드 추가
```

#### 기술적 세부사항
**CommentService.java - deleteComment() 변경 내용:**
```java
// 변경 전: 소프트 삭제
public void deleteComment(Long id) {
    Comment comment = commentRepository.findById(id)
            .orElseThrow(() -> new RuntimeException("Comment not found with id: " + id));
    comment.setIsDeleted(true);
    comment.setContent("削除されたコメントです。");

    // 게시글 댓글 수 감소
    Post post = postRepository.findById(comment.getPostId()).get();
    post.setCommentCount(post.getCommentCount() - 1);
    postRepository.save(post);

    commentRepository.save(comment);  // 소프트 삭제
}

// 변경 후: 하드 삭제 + 고아화
public void deleteComment(Long id) {
    Comment comment = commentRepository.findById(id)
            .orElseThrow(() -> new RuntimeException("Comment not found with id: " + id));

    // 1. 자식 댓글 고아화 (parentId를 null로 설정)
    List<Comment> childComments = commentRepository.findByParentIdOrderByCreatedAtAsc(id);
    for (Comment child : childComments) {
        child.setParentId(null);
        commentRepository.save(child);
    }

    // 2. 게시글 댓글 수 감소
    Post post = postRepository.findById(comment.getPostId()).get();
    post.setCommentCount(Math.max(0, post.getCommentCount() - 1));
    postRepository.save(post);

    // 3. 관련 좋아요 로그 삭제 (외래 키 제약 조건 처리)
    commentLikeLogRepository.deleteByCommentId(id);

    // 4. 댓글 하드 삭제
    commentRepository.delete(comment);
}
```

**CommentLikeLogRepository.java - 새 메서드:**
```java
@Transactional
void deleteByCommentId(Long commentId);
```

#### 삭제 프로세스 순서도
```
1. 삭제할 댓글 조회
   ↓
2. 자식 댓글 찾기 (parentId = 삭제할 댓글 ID)
   ↓
3. 각 자식 댓글의 parentId를 null로 설정 (고아화)
   ↓
4. 게시글의 commentCount 감소
   ↓
5. 댓글에 대한 모든 좋아요 로그 삭제
   ↓
6. 댓글을 데이터베이스에서 완전히 삭제
```

#### 대댓글 처리 예시
```
변경 전:
[댓글 A] - parentId: null
  ├─ [대댓글 B] - parentId: A.id
  └─ [대댓글 C] - parentId: A.id

댓글 A 삭제 후:
[댓글 A: "削除されたコメントです。"] - isDeleted: true
  ├─ [대댓글 B] - parentId: A.id (여전히 연결)
  └─ [대댓글 C] - parentId: A.id (여전히 연결)

변경 후:
[댓글 A 삭제됨 - DB에서 제거]
[대댓글 B] - parentId: null (최상위 댓글로 승격)
[대댓글 C] - parentId: null (최상위 댓글로 승격)
```

---

## 테스트 가이드

### 1. 좋아요/싫어요 1회 제한 테스트

**준비:**
1. 백엔드와 프론트엔드 서버 실행
2. 테스트용 게시글 생성

**테스트 절차:**
```
1. 사용자 A로 로그인
2. 게시글에 좋아요 클릭 → 좋아요 수 증가 확인
3. 같은 게시글에 다시 좋아요 클릭 → 좋아요 수 변화 없음 확인 ✅
4. 로그아웃 후 사용자 B로 로그인
5. 같은 게시글에 좋아요 클릭 → 좋아요 수 증가 확인 ✅
6. 로그아웃 (비로그인 상태)
7. 같은 게시글에 좋아요 클릭 → 좋아요 수 증가 확인 (IP 기반)
8. 쿠키 삭제 후 같은 IP에서 다시 좋아요 → 좋아요 수 변화 없음 확인 ✅
```

**예상 결과:**
- 각 사용자는 게시글당 1회만 좋아요/싫어요 가능
- 비로그인 사용자는 IP 주소당 1회만 가능

---

### 2. 댓글 타임스탬프 테스트

**테스트 절차:**
```
1. 새 댓글 작성
2. 즉시 확인 → "0分前" 표시 확인 ✅
3. 2-3분 대기
4. 새로고침 → "2分前" 또는 "3分前" 표시 확인 ✅
5. 댓글 수정 (내용 변경 후 저장)
6. 수정 후 확인 → "（編集済み）" 표시 없음 확인 ✅
7. 페이지 새로고침
8. 여전히 수정됨 표시 없음 확인 ✅
```

**예상 결과:**
- "たった今" 표시 사라짐
- 모든 댓글은 "X分前" 형식으로 표시
- 수정된 댓글도 수정됨 표시 없음

---

### 3. 댓글 하드 삭제 테스트

**테스트 절차:**
```
1. 사용자 A로 로그인하여 댓글 A 작성
2. 댓글 A에 대댓글 B 작성
3. 댓글 A에 좋아요 클릭
4. 댓글 A 삭제 클릭
5. 확인 대화상자에서 확인
```

**예상 결과:**
- ✅ 댓글 A가 화면에서 완전히 사라짐
- ✅ 대댓글 B는 여전히 보이지만 최상위 댓글로 표시됨 (들여쓰기 없음)
- ✅ 게시글의 댓글 수가 1 감소
- ✅ 데이터베이스에서 댓글 A 완전히 삭제됨

**데이터베이스 검증 쿼리:**
```sql
-- 댓글이 삭제되었는지 확인
SELECT * FROM comments WHERE id = <삭제한_댓글_id>;
-- 결과: 0 rows (완전히 삭제됨)

-- 좋아요 로그가 삭제되었는지 확인
SELECT * FROM comment_like_logs WHERE comment_id = <삭제한_댓글_id>;
-- 결과: 0 rows (함께 삭제됨)

-- 대댓글이 고아화되었는지 확인
SELECT id, parent_id, content FROM comments WHERE id = <대댓글_id>;
-- 결과: parent_id = NULL

-- 게시글 댓글 수 확인
SELECT comment_count FROM posts WHERE id = <게시글_id>;
-- 결과: 이전 값 - 1
```

---

### 4. 엣지 케이스 테스트

#### 케이스 1: 여러 단계의 대댓글 삭제
```
구조:
[댓글 A]
  ├─ [대댓글 B]
  │   └─ [대대댓글 C]
  └─ [대댓글 D]

댓글 A 삭제 시:
[대댓글 B] - parentId: null
  └─ [대대댓글 C] - parentId: B (변화 없음)
[대댓글 D] - parentId: null
```

#### 케이스 2: 동시 좋아요 클릭
```
1. 같은 게시글을 두 개의 브라우저 탭에서 열기
2. 동시에 좋아요 버튼 클릭
3. 예상 결과: 좋아요 수는 1만 증가 (중복 방지)
```

#### 케이스 3: 삭제된 댓글이 있는 게시글의 댓글 수 정합성
```
1. 게시글에 댓글 5개 작성
2. 댓글 2개 삭제
3. 게시글의 commentCount = 3 확인
4. 실제 DB의 댓글 개수 = 3 확인
```

---

## 데이터베이스 스키마 변경

### 영향받는 테이블

#### 1. `post_like_logs` 테이블
- **변경 없음** (기존 구조 유지)
- 새로운 인덱스 권장사항:
  ```sql
  CREATE INDEX idx_post_like_user ON post_like_logs(post_id, user_id);
  CREATE INDEX idx_post_like_ip ON post_like_logs(post_id, ip_address);
  ```

#### 2. `post_dislike_logs` 테이블
- **변경 없음** (기존 구조 유지)
- 새로운 인덱스 권장사항:
  ```sql
  CREATE INDEX idx_post_dislike_user ON post_dislike_logs(post_id, user_id);
  CREATE INDEX idx_post_dislike_ip ON post_dislike_logs(post_id, ip_address);
  ```

#### 3. `comment_like_logs` 테이블
- **외래 키 제약 조건 확인 필요**
- `comment_id`에 대한 외래 키가 `ON DELETE CASCADE`로 설정되어 있는지 확인
- 설정되어 있지 않다면 수동으로 `deleteByCommentId()` 메서드가 처리

#### 4. `comments` 테이블
- **변경 없음**
- `parent_id` 컬럼은 nullable이어야 함 (고아화된 댓글을 위해)

---

## 성능 영향 분석

### 1. 좋아요/싫어요 조회 쿼리
**변경 전:**
```sql
SELECT * FROM post_like_logs
WHERE post_id = ?
  AND user_id = ?
  AND liked_at > '2026-02-09 00:00:00';
```

**변경 후:**
```sql
SELECT * FROM post_like_logs
WHERE post_id = ?
  AND user_id = ?;
```

**성능 영향:**
- ✅ 쿼리가 더 단순해짐 (`liked_at` 조건 제거)
- ✅ 인덱스 최적화가 더 쉬워짐
- ⚠️ 시간이 지나면서 `post_like_logs` 테이블 크기 증가 (삭제되지 않으므로)

**권장사항:**
- `(post_id, user_id)` 복합 인덱스 생성
- 정기적인 데이터 아카이빙 전략 수립 (선택사항)

---

### 2. 댓글 삭제 프로세스
**변경 전 (소프트 삭제):**
```sql
UPDATE comments
SET is_deleted = true, content = '削除されたコメントです。'
WHERE id = ?;
```

**변경 후 (하드 삭제):**
```sql
-- 1. 자식 댓글 고아화
UPDATE comments SET parent_id = NULL WHERE parent_id = ?;

-- 2. 좋아요 로그 삭제
DELETE FROM comment_like_logs WHERE comment_id = ?;

-- 3. 댓글 삭제
DELETE FROM comments WHERE id = ?;
```

**성능 영향:**
- ⚠️ 쿼리 개수 증가 (1개 → 3개)
- ✅ 데이터베이스 크기 감소 (삭제된 데이터 제거)
- ✅ 조회 쿼리 성능 향상 (`is_deleted` 필터 불필요)

**트랜잭션 처리:**
- `@Transactional` 어노테이션으로 원자성 보장
- 모든 쿼리가 성공하거나 모두 롤백

---

## 롤백 가이드

만약 문제가 발생하여 이전 버전으로 되돌려야 한다면:

### Git을 이용한 롤백
```bash
# 변경된 파일 목록 확인
git status

# 특정 파일만 되돌리기
git checkout HEAD -- frontend/src/pages/Board/CommentSection.js
git checkout HEAD -- backend/src/main/java/com/ej2/service/PostService.java
git checkout HEAD -- backend/src/main/java/com/ej2/service/CommentService.java

# 전체 되돌리기 (커밋 전인 경우)
git reset --hard HEAD
```

### 개별 기능별 롤백 방법

#### 1. 좋아요/싫어요 기능만 롤백
```java
// PostService.java의 incrementLikeCount(), incrementDislikeCount() 메서드를
// 이전 버전으로 교체 (24시간 체크 로직 복원)
```

#### 2. 댓글 타임스탬프만 롤백
```javascript
// CommentSection.js의 getTimeAgo() 함수에
// if (diffInMinutes < 1) return 'たった今'; 라인 추가
// 수정됨 표시 블록 복원
```

#### 3. 댓글 하드 삭제만 롤백
```java
// CommentService.java의 deleteComment() 메서드를
// 이전 소프트 삭제 방식으로 교체
```

---

## 관련 문서

- [게시판 CRUD 구현 가이드](./06_게시판_CRUD_구현_가이드.md)
- [댓글 기능 구현 가이드](./07_댓글_기능_구현_가이드.md)

---

## 작업 이력

- **날짜:** 2026-02-10
- **작업자:** Claude Code
- **변경 파일 수:** 7개
  - Frontend: 1개
  - Backend: 6개

---

## 향후 개선 사항 제안

### 1. 좋아요/싫어요 기능
- [ ] 좋아요 취소 기능 추가 (toggle 방식)
- [ ] 좋아요한 게시글 목록 보기 기능
- [ ] 좋아요 수 실시간 업데이트 (WebSocket)

### 2. 댓글 기능
- [ ] 댓글 복구 기능 (휴지통)
- [ ] 댓글 신고 기능
- [ ] 댓글 정렬 옵션 (최신순, 좋아요순)

### 3. 성능 최적화
- [ ] 좋아요 로그 테이블 파티셔닝
- [ ] 댓글 페이지네이션
- [ ] 캐싱 전략 수립 (Redis)

---

**문서 버전:** 1.0
**최종 수정일:** 2026-02-10
