# 05. ì±„íŒ…ë°© êµ¬í˜„ ê°€ì´ë“œ

> ì´ ë¬¸ì„œëŠ” EJ2 í”„ë¡œì íŠ¸ì˜ **ì‹¤ì‹œê°„ ì±„íŒ…** ê¸°ëŠ¥ì„ ì„¤ëª…í•©ë‹ˆë‹¤.
> WebSocket + STOMP í”„ë¡œí† ì½œì„ ì‚¬ìš©í•œ ì‹¤ì‹œê°„ ë©”ì‹œì§• ì‹œìŠ¤í…œì…ë‹ˆë‹¤.

---

## ëª©ì°¨

1. [ì „ì²´ íë¦„ ì´í•´í•˜ê¸°](#1-ì „ì²´-íë¦„-ì´í•´í•˜ê¸°)
2. [í•µì‹¬ ê°œë…: WebSocketê³¼ STOMP](#2-í•µì‹¬-ê°œë…-websocketê³¼-stomp)
3. [ë°±ì—”ë“œ êµ¬í˜„](#3-ë°±ì—”ë“œ-êµ¬í˜„)
   - 3.1 [WebSocketConfig (ì„¤ì •)](#31-websocketconfig-ì„¤ì •)
   - 3.2 [ChatRoom / ChatMessage ì—”í‹°í‹°](#32-chatroom--chatmessage-ì—”í‹°í‹°)
   - 3.3 [ChatService (ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§)](#33-chatservice-ë¹„ì¦ˆë‹ˆìŠ¤-ë¡œì§)
   - 3.4 [ChatController (REST + WebSocket)](#34-chatcontroller-rest--websocket)
4. [í”„ë¡ íŠ¸ì—”ë“œ êµ¬í˜„](#4-í”„ë¡ íŠ¸ì—”ë“œ-êµ¬í˜„)
   - 4.1 [ChatPage ì „ì²´ êµ¬ì¡°](#41-chatpage-ì „ì²´-êµ¬ì¡°)
   - 4.2 [ì±„íŒ… ì´ˆê¸°í™” ê³¼ì •](#42-ì±„íŒ…-ì´ˆê¸°í™”-ê³¼ì •)
   - 4.3 [ë©”ì‹œì§€ ì†¡ìˆ˜ì‹ ](#43-ë©”ì‹œì§€-ì†¡ìˆ˜ì‹ )
   - 4.4 [ì—°ê²° í•´ì œ ì²˜ë¦¬](#44-ì—°ê²°-í•´ì œ-ì²˜ë¦¬)
   - 4.5 [useRef ì‚¬ìš© ì´ìœ ](#45-useref-ì‚¬ìš©-ì´ìœ )
5. [ìµëª… ë‹‰ë„¤ì„ ì‹œìŠ¤í…œ](#5-ìµëª…-ë‹‰ë„¤ì„-ì‹œìŠ¤í…œ)
6. [ë©”ì‹œì§€ íƒ€ì…ë³„ ì²˜ë¦¬](#6-ë©”ì‹œì§€-íƒ€ì…ë³„-ì²˜ë¦¬)
7. [ìì£¼ ë°œìƒí•˜ëŠ” ì—ëŸ¬ì™€ í•´ê²°ë²•](#7-ìì£¼-ë°œìƒí•˜ëŠ”-ì—ëŸ¬ì™€-í•´ê²°ë²•)

---

## 1. ì „ì²´ íë¦„ ì´í•´í•˜ê¸°

```
[ì‚¬ìš©ì A]                  [ì„œë²„]                    [ì‚¬ìš©ì B]
    |                         |                          |
    |  1. ë‹‰ë„¤ì„ ìš”ì²­          |                          |
    |â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’|                          |
    |â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€|  "ìµëª…1" í• ë‹¹              |
    |                         |                          |
    |  2. WebSocket ì—°ê²°       |                          |
    |â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â†’|                          |
    |                         |                          |
    |  3. JOIN ë©”ì‹œì§€ ì „ì†¡      |                          |
    |â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’|  4. ì „ì²´ ë¸Œë¡œë“œìºìŠ¤íŠ¸       |
    |                         |â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ |
    |  "ìµëª…1ë‹˜ì´ ì…ì¥"        |   "ìµëª…1ë‹˜ì´ ì…ì¥"         |
    |                         |                          |
    |  5. ì±„íŒ… ë©”ì‹œì§€ ì „ì†¡      |                          |
    |â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’|  6. ì „ì²´ ë¸Œë¡œë“œìºìŠ¤íŠ¸       |
    |                         |â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ |
    |  "ì•ˆë…•í•˜ì„¸ìš”!"           |   "ìµëª…1: ì•ˆë…•í•˜ì„¸ìš”!"     |
    |                         |                          |
    |  7. ë¸Œë¼ìš°ì € ë‹«ê¸°         |                          |
    |â•â•â•â•â•â•â•â•â•â•â•â•X (ì—°ê²° ëŠê¹€)  |  8. LEAVE ê°ì§€            |
    |                         |â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ |
    |                         |   "ìµëª…1ë‹˜ì´ í‡´ì¥"         |
```

---

## 2. í•µì‹¬ ê°œë…: WebSocketê³¼ STOMP

### HTTP vs WebSocket

```
HTTP (ì¼ë°˜ ì›¹ ìš”ì²­):
í´ë¼ì´ì–¸íŠ¸ â†’ ìš”ì²­ â†’ ì„œë²„ â†’ ì‘ë‹µ â†’ ì—°ê²° ì¢…ë£Œ
í´ë¼ì´ì–¸íŠ¸ â†’ ìš”ì²­ â†’ ì„œë²„ â†’ ì‘ë‹µ â†’ ì—°ê²° ì¢…ë£Œ
(ë§¤ë²ˆ ìƒˆë¡œ ì—°ê²°í•´ì•¼ í•¨)

WebSocket (ì‹¤ì‹œê°„ í†µì‹ ):
í´ë¼ì´ì–¸íŠ¸ â†â•â•â•â•â•â•â•â•â•â•â•â•â•â•â†’ ì„œë²„
         (í•œ ë²ˆ ì—°ê²°í•˜ë©´ ê³„ì† ìœ ì§€)
         (ì„œë²„ë„ í´ë¼ì´ì–¸íŠ¸ì— ë¨¼ì € ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ìˆ˜ ìˆìŒ)
```

| íŠ¹ì§• | HTTP | WebSocket |
|------|------|-----------|
| ì—°ê²° ë°©ì‹ | ìš”ì²­-ì‘ë‹µ í›„ ì¢…ë£Œ | í•œ ë²ˆ ì—°ê²° í›„ ìœ ì§€ |
| ë°©í–¥ | í´ë¼ì´ì–¸íŠ¸ â†’ ì„œë²„ | ì–‘ë°©í–¥ |
| ì‹¤ì‹œê°„ì„± | ì—†ìŒ (í´ë§ í•„ìš”) | ì¦‰ì‹œ ì „ë‹¬ |
| ì‚¬ìš© ì‚¬ë¡€ | API í˜¸ì¶œ, í˜ì´ì§€ ë¡œë“œ | ì±„íŒ…, ì•Œë¦¼, ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ |

### STOMP í”„ë¡œí† ì½œ

```
STOMP = Simple Text Oriented Messaging Protocol
WebSocket ìœ„ì—ì„œ ë™ì‘í•˜ëŠ” ë©”ì‹œì§• ê·œì•½

WebSocketë§Œìœ¼ë¡œë„ í†µì‹  ê°€ëŠ¥í•˜ì§€ë§Œ, STOMPë¥¼ ì“°ë©´:
- "êµ¬ë…(subscribe)" ê°œë… ì‚¬ìš© ê°€ëŠ¥ (íŠ¹ì • ì±„íŒ…ë°©ë§Œ ë°›ê¸°)
- "ë°œí–‰(publish)" ê°œë… ì‚¬ìš© ê°€ëŠ¥ (ë©”ì‹œì§€ ë³´ë‚´ê¸°)
- ë©”ì‹œì§€ ë¼ìš°íŒ… ìë™ ì²˜ë¦¬
```

```
STOMP í†µì‹  íŒ¨í„´:

êµ¬ë… (Subscribe):
client.subscribe('/topic/chat/1', callback)
â†’ "ì±„íŒ…ë°© 1ë²ˆì˜ ë©”ì‹œì§€ë¥¼ ë°›ê² ìŠµë‹ˆë‹¤"

ë°œí–‰ (Publish):
client.publish({ destination: '/app/chat/1/send', body: '...' })
â†’ "ì±„íŒ…ë°© 1ë²ˆì— ë©”ì‹œì§€ë¥¼ ë³´ëƒ…ë‹ˆë‹¤"

ì„œë²„ê°€ ë¸Œë¡œë“œìºìŠ¤íŠ¸:
messagingTemplate.convertAndSend('/topic/chat/1', message)
â†’ "/topic/chat/1"ì„ êµ¬ë… ì¤‘ì¸ ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì „ë‹¬
```

### SockJS í´ë°±

```javascript
new SockJS('/ws/chat')  // WebSocket ì—°ê²° ì‹œë„, ì‹¤íŒ¨í•˜ë©´ HTTP í´ë°±

ë¸Œë¼ìš°ì €ê°€ WebSocketì„ ì§€ì›í•˜ë©´ â†’ WebSocket ì‚¬ìš©
ë¸Œë¼ìš°ì €ê°€ WebSocketì„ ì§€ì› ì•ˆ í•˜ë©´ â†’ HTTP ë¡±í´ë§ìœ¼ë¡œ ëŒ€ì²´
â†’ ëª¨ë“  ë¸Œë¼ìš°ì €ì—ì„œ ë™ì‘ ë³´ì¥
```

---

## 3. ë°±ì—”ë“œ êµ¬í˜„

### 3.1 WebSocketConfig (ì„¤ì •)

> **íŒŒì¼ ìœ„ì¹˜**: `backend/src/main/java/com/ej2/config/WebSocketConfig.java`

```java
@Configuration
@EnableWebSocketMessageBroker  // WebSocket ë©”ì‹œì§€ ë¸Œë¡œì»¤ í™œì„±í™”
public class WebSocketConfig implements WebSocketMessageBrokerConfigurer {

    @Override
    public void configureMessageBroker(MessageBrokerRegistry config) {
        config.enableSimpleBroker("/topic");  // êµ¬ë… ê²½ë¡œ ì ‘ë‘ì‚¬
        config.setApplicationDestinationPrefixes("/app");  // ë°œí–‰ ê²½ë¡œ ì ‘ë‘ì‚¬
    }

    @Override
    public void registerStompEndpoints(StompEndpointRegistry registry) {
        registry.addEndpoint("/ws/chat")  // WebSocket ì—°ê²° ì—”ë“œí¬ì¸íŠ¸
                .setAllowedOriginPatterns("*")
                .withSockJS();            // SockJS í´ë°± ì§€ì›
    }
}
```

#### ê²½ë¡œ êµ¬ì¡°

```
/ws/chat          â† WebSocket ì—°ê²° ì—”ë“œí¬ì¸íŠ¸ (ìµœì´ˆ 1íšŒ ì—°ê²°)
/app/chat/1/send  â† ë©”ì‹œì§€ ë°œí–‰ ê²½ë¡œ (í´ë¼ì´ì–¸íŠ¸ â†’ ì„œë²„)
/topic/chat/1     â† ë©”ì‹œì§€ êµ¬ë… ê²½ë¡œ (ì„œë²„ â†’ í´ë¼ì´ì–¸íŠ¸)

[í´ë¼ì´ì–¸íŠ¸] --publish--> /app/chat/1/send --[ì„œë²„ ì²˜ë¦¬]--> /topic/chat/1 --> [ëª¨ë“  êµ¬ë…ì]
```

### 3.2 ChatRoom / ChatMessage ì—”í‹°í‹°

```java
@Entity
@Table(name = "chat_rooms")
public class ChatRoom {
    @Id @GeneratedValue
    private Long id;
    private String name;              // ì±„íŒ…ë°© ì´ë¦„
    private String description;       // ì„¤ëª…
    private Integer maxUsers = 100;   // ìµœëŒ€ ì¸ì›
    private Integer currentUsers = 0; // í˜„ì¬ ì¸ì›
    private Integer nicknameCounter = 0;  // ë‹‰ë„¤ì„ ìˆœë²ˆ ì¹´ìš´í„°

    @Version                          // ë‚™ê´€ì  ì ê¸ˆ (ë™ì‹œ ì ‘ì† ì²˜ë¦¬)
    private Long version;
}
```

```java
@Entity
@Table(name = "chat_messages")
public class ChatMessage {
    @Id @GeneratedValue
    private Long id;
    private Long roomId;
    private String type;              // CHAT, JOIN, LEAVE
    private String content;           // ë©”ì‹œì§€ ë‚´ìš©
    private String senderNickname;    // ë³´ë‚¸ ì‚¬ëŒ ë‹‰ë„¤ì„
    private LocalDateTime createdAt;
}
```

#### @Version (ë‚™ê´€ì  ì ê¸ˆ)ì´ë€?

```
ë¬¸ì œ ìƒí™©:
ì‚¬ìš©ì Aì™€ Bê°€ ë™ì‹œì— ì±„íŒ…ë°©ì— ì…ì¥
ë‘˜ ë‹¤ currentUsers = 0ì„ ì½ìŒ
A: currentUsers = 0 + 1 = 1ë¡œ ì—…ë°ì´íŠ¸
B: currentUsers = 0 + 1 = 1ë¡œ ì—…ë°ì´íŠ¸ (Aì˜ ì—…ë°ì´íŠ¸ë¥¼ ë®ì–´ì”€!)
ê²°ê³¼: 2ëª…ì¸ë° currentUsers = 1 (ì˜¤ë¥˜!)

@Versionìœ¼ë¡œ í•´ê²°:
A: version=0 ì½ìŒ â†’ version=1ë¡œ ì—…ë°ì´íŠ¸ ì„±ê³µ
B: version=0 ì½ìŒ â†’ ì—…ë°ì´íŠ¸ ì‹œë„ â†’ DBì˜ versionì´ ì´ë¯¸ 1 â†’ ì‹¤íŒ¨!
B: ë‹¤ì‹œ ì½ê¸° â†’ version=1 â†’ version=2ë¡œ ì—…ë°ì´íŠ¸ ì„±ê³µ
ê²°ê³¼: currentUsers = 2 (ì •í™•!)
```

### 3.3 ChatService (ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§)

> **íŒŒì¼ ìœ„ì¹˜**: `backend/src/main/java/com/ej2/service/ChatService.java`

#### ê¸€ë¡œë²Œ ì±„íŒ…ë°© ìë™ ìƒì„±

```java
@PostConstruct  // ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹œ ìë™ ì‹¤í–‰
public void initGlobalRoom() {
    ChatRoom globalRoom = chatRoomRepository.findById(1L);
    if (globalRoom == null) {
        globalRoom = new ChatRoom();
        globalRoom.setName("ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒãƒ£ãƒƒãƒˆ");
        globalRoom.setDescription("å…¨ä½“ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ ");
        chatRoomRepository.save(globalRoom);
    }
}
```

#### ë‹‰ë„¤ì„ í• ë‹¹ (ë‚™ê´€ì  ì ê¸ˆ + ì¬ì‹œë„)

```java
public String assignNickname(Long roomId, boolean useAnonymous) {
    int maxRetries = 3;

    for (int i = 0; i < maxRetries; i++) {
        try {
            ChatRoom room = chatRoomRepository.findById(roomId);
            int nextNumber = room.getNicknameCounter() + 1;

            room.setNicknameCounter(nextNumber);
            room.setCurrentUsers(room.getCurrentUsers() + 1);
            chatRoomRepository.save(room);  // @Versionìœ¼ë¡œ ë™ì‹œì„± ì œì–´

            return "åŒ¿å" + nextNumber;  // "ìµëª…1", "ìµëª…2", ...
        } catch (Exception e) {
            if (i == maxRetries - 1) throw e;
            // ì¬ì‹œë„
        }
    }
}
```

**ì¬ì‹œë„ íŒ¨í„´ (Retry Pattern)**:
```
ì‹œë„ 1: version=0 â†’ ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ë¨¼ì € ìˆ˜ì • â†’ ì‹¤íŒ¨
ì‹œë„ 2: version=1 â†’ ë‹¤ì‹œ ë‹¤ë¥¸ ì‚¬ìš©ìê°€ â†’ ì‹¤íŒ¨
ì‹œë„ 3: version=2 â†’ ì„±ê³µ!

3ë²ˆê¹Œì§€ ì¬ì‹œë„í•˜ë©´ ëŒ€ë¶€ë¶„ ì„±ê³µ. ê·¸ë˜ë„ ì‹¤íŒ¨í•˜ë©´ ì—ëŸ¬ ë°˜í™˜.
```

### 3.4 ChatController (REST + WebSocket)

> **íŒŒì¼ ìœ„ì¹˜**: `backend/src/main/java/com/ej2/controller/ChatController.java`

ì´ ì»¨íŠ¸ë¡¤ëŸ¬ëŠ” **ë‘ ê°€ì§€ ì—­í• **ì„ í•©ë‹ˆë‹¤:

```java
@RestController
public class ChatController {

    @Autowired
    private SimpMessagingTemplate messagingTemplate;  // WebSocket ë©”ì‹œì§€ ì „ì†¡ ë„êµ¬

    // ===== REST API (HTTP ìš”ì²­) =====

    // ì±„íŒ…ë°© ëª©ë¡ ì¡°íšŒ
    @GetMapping("/api/chat/rooms")
    public List<ChatRoom> getRooms() { ... }

    // ë‹‰ë„¤ì„ í• ë‹¹
    @PostMapping("/api/chat/rooms/{roomId}/nickname")
    public Map<String, String> assignNickname(...) { ... }

    // ===== WebSocket í•¸ë“¤ëŸ¬ (STOMP ë©”ì‹œì§€) =====

    // ì±„íŒ… ë©”ì‹œì§€ ìˆ˜ì‹  â†’ ë¸Œë¡œë“œìºìŠ¤íŠ¸
    @MessageMapping("/chat/{roomId}/send")
    public void sendMessage(@DestinationVariable Long roomId, ChatMessage message) {
        message.setRoomId(roomId);
        message.setType("CHAT");
        chatService.saveMessage(message);

        // í•´ë‹¹ ë°©ì˜ ëª¨ë“  êµ¬ë…ìì—ê²Œ ì „ì†¡
        messagingTemplate.convertAndSend("/topic/chat/" + roomId, message);
    }

    // ì…ì¥ ë©”ì‹œì§€
    @MessageMapping("/chat/{roomId}/join")
    public void joinRoom(@DestinationVariable Long roomId, ChatMessage message) {
        message.setContent(message.getSenderNickname() + "ã•ã‚“ãŒå…¥å®¤ã—ã¾ã—ãŸ");
        message.setType("JOIN");
        chatService.saveMessage(message);

        messagingTemplate.convertAndSend("/topic/chat/" + roomId, message);
    }

    // í‡´ì¥ ë©”ì‹œì§€
    @MessageMapping("/chat/{roomId}/leave")
    public void leaveRoom(@DestinationVariable Long roomId, ChatMessage message) {
        message.setContent(message.getSenderNickname() + "ã•ã‚“ãŒé€€å®¤ã—ã¾ã—ãŸ");
        message.setType("LEAVE");
        chatService.saveMessage(message);

        messagingTemplate.convertAndSend("/topic/chat/" + roomId, message);
        chatService.userLeave(roomId);
    }
}
```

#### @MessageMapping vs @GetMapping/@PostMapping

```
@GetMapping("/api/chat/rooms")
â†’ HTTP GET ìš”ì²­ì„ ì²˜ë¦¬
â†’ ë¸Œë¼ìš°ì €ì—ì„œ URLë¡œ ì ‘ì† ê°€ëŠ¥

@MessageMapping("/chat/{roomId}/send")
â†’ WebSocket STOMP ë©”ì‹œì§€ë¥¼ ì²˜ë¦¬
â†’ client.publish({destination: '/app/chat/1/send'}) ë¡œë§Œ ì ‘ê·¼ ê°€ëŠ¥
â†’ HTTP ìš”ì²­ìœ¼ë¡œëŠ” ì ‘ê·¼ ë¶ˆê°€
```

---

## 4. í”„ë¡ íŠ¸ì—”ë“œ êµ¬í˜„

### 4.1 ChatPage ì „ì²´ êµ¬ì¡°

> **íŒŒì¼ ìœ„ì¹˜**: `frontend/src/pages/Chat/ChatPage.js`

```javascript
function ChatPage() {
    // ìƒíƒœ
    const [messages, setMessages] = useState([]);          // ë©”ì‹œì§€ ëª©ë¡
    const [inputMessage, setInputMessage] = useState('');  // ì…ë ¥ ì¤‘ì¸ ë©”ì‹œì§€
    const [nickname, setNickname] = useState('');           // ë‚´ ë‹‰ë„¤ì„
    const [connected, setConnected] = useState(false);     // ì—°ê²° ìƒíƒœ
    const [connecting, setConnecting] = useState(true);    // ì—°ê²° ì¤‘...

    // Ref (ë¦¬ë Œë”ë§ ì—†ì´ ê°’ ìœ ì§€)
    const stompClientRef = useRef(null);     // STOMP í´ë¼ì´ì–¸íŠ¸
    const messagesEndRef = useRef(null);     // ìŠ¤í¬ë¡¤ ë ìœ„ì¹˜
    const subscriptionRef = useRef(null);    // êµ¬ë… ê°ì²´
    const nicknameRef = useRef('');           // ë‹‰ë„¤ì„ (ì½œë°±ì—ì„œ ìµœì‹ ê°’ ì°¸ì¡°)
}
```

### 4.2 ì±„íŒ… ì´ˆê¸°í™” ê³¼ì •

```javascript
const initChat = async () => {
    try {
        // 1ë‹¨ê³„: ì„œë²„ì—ì„œ ìµëª… ë‹‰ë„¤ì„ ë°›ê¸°
        const nicknameRes = await axios.post(`/api/chat/rooms/${GLOBAL_ROOM_ID}/nickname`, {
            useAnonymous: true
        });
        const assignedNickname = nicknameRes.data.nickname;  // "åŒ¿å3"
        setNickname(assignedNickname);
        nicknameRef.current = assignedNickname;

        // 2ë‹¨ê³„: ì´ì „ ë©”ì‹œì§€ ë¡œë“œí•˜ì§€ ì•ŠìŒ (í”„ë¼ì´ë²„ì‹œ)
        setMessages([]);

        // 3ë‹¨ê³„: WebSocket ì—°ê²°
        const client = new Client({
            webSocketFactory: () => new SockJS('/ws/chat'),  // WebSocket ìƒì„±
            debug: () => {},  // ë””ë²„ê·¸ ë¡œê·¸ ë¹„í™œì„±í™”

            onConnect: () => {
                // ì—°ê²° ì„±ê³µ!
                setConnected(true);
                setConnecting(false);
                stompClientRef.current = client;

                // 4ë‹¨ê³„: ì±„íŒ…ë°© êµ¬ë…
                subscriptionRef.current = client.subscribe(
                    `/topic/chat/${GLOBAL_ROOM_ID}`,
                    (messageOutput) => {
                        const msg = JSON.parse(messageOutput.body);
                        setMessages(prev => [...prev, msg]);
                    }
                );

                // 5ë‹¨ê³„: ì…ì¥ ë©”ì‹œì§€ ì „ì†¡
                client.publish({
                    destination: `/app/chat/${GLOBAL_ROOM_ID}/join`,
                    body: JSON.stringify({
                        senderNickname: assignedNickname,
                        type: 'JOIN'
                    })
                });
            }
        });
        client.activate();  // ì—°ê²° ì‹œì‘!
    } catch (error) {
        setConnecting(false);
    }
};
```

#### ì´ˆê¸°í™” ìˆœì„œë„

```
initChat() í˜¸ì¶œ
    â†“
[1] POST /api/chat/rooms/1/nickname â†’ "åŒ¿å3" í• ë‹¹
    â†“
[2] messages = [] (ë¹ˆ ë°°ì—´ë¡œ ì‹œì‘)
    â†“
[3] new Client({ webSocketFactory: SockJS }) â†’ ì—°ê²° ì‹œë„
    â†“
[4] onConnect ì½œë°± ì‹¤í–‰
    â”œâ”€â”€ connected = true
    â”œâ”€â”€ subscribe('/topic/chat/1') â†’ ë©”ì‹œì§€ ìˆ˜ì‹  ëŒ€ê¸°
    â””â”€â”€ publish('/app/chat/1/join') â†’ "åŒ¿å3ã•ã‚“ãŒå…¥å®¤ã—ã¾ã—ãŸ"
```

### 4.3 ë©”ì‹œì§€ ì†¡ìˆ˜ì‹ 

#### ë©”ì‹œì§€ ë³´ë‚´ê¸°

```javascript
const sendMessage = (e) => {
    e.preventDefault();
    if (!inputMessage.trim() || !stompClientRef.current || !connected) return;

    stompClientRef.current.publish({
        destination: `/app/chat/${GLOBAL_ROOM_ID}/send`,
        body: JSON.stringify({
            senderNickname: nickname,
            content: inputMessage.trim(),
            type: 'CHAT'
        })
    });
    setInputMessage('');  // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
};
```

#### ë©”ì‹œì§€ ë°›ê¸° (êµ¬ë… ì½œë°±)

```javascript
client.subscribe(`/topic/chat/${GLOBAL_ROOM_ID}`, (messageOutput) => {
    const msg = JSON.parse(messageOutput.body);
    setMessages(prev => [...prev, msg]);  // ê¸°ì¡´ ë©”ì‹œì§€ + ìƒˆ ë©”ì‹œì§€
});
```

**`prev => [...prev, msg]` íŒ¨í„´ ì„¤ëª…**:
```javascript
// ê¸°ì¡´ ë©”ì‹œì§€: ["ì•ˆë…•", "ë°˜ê°€ì›Œ"]
// ìƒˆ ë©”ì‹œì§€: "ì˜ ì§€ë‚´?"

setMessages(prev => [...prev, msg]);
// prev = ["ì•ˆë…•", "ë°˜ê°€ì›Œ"]
// [...prev, msg] = ["ì•ˆë…•", "ë°˜ê°€ì›Œ", "ì˜ ì§€ë‚´?"]
// â†’ ê¸°ì¡´ ë©”ì‹œì§€ ìœ ì§€ + ìƒˆ ë©”ì‹œì§€ ì¶”ê°€
```

#### ìë™ ìŠ¤í¬ë¡¤

```javascript
useEffect(() => {
    scrollToBottom();
}, [messages]);  // messagesê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ ì‹¤í–‰

const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
};
```

```jsx
<div className="chat-messages">
    {/* ë©”ì‹œì§€ë“¤ */}
    <div ref={messagesEndRef} />  {/* â† ì´ ë¹ˆ divê°€ í•­ìƒ ë§¨ ì•„ë˜ */}
</div>
```

**scrollIntoView**: í•´ë‹¹ ìš”ì†Œê°€ ë³´ì´ë„ë¡ ìŠ¤í¬ë¡¤í•©ë‹ˆë‹¤. `messagesEndRef`ê°€ í•­ìƒ ë©”ì‹œì§€ ëª©ë¡ ë§¨ ì•„ë˜ì— ìˆìœ¼ë¯€ë¡œ, ìƒˆ ë©”ì‹œì§€ê°€ ì¶”ê°€ë˜ë©´ ìë™ìœ¼ë¡œ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤ë©ë‹ˆë‹¤.

### 4.4 ì—°ê²° í•´ì œ ì²˜ë¦¬

```javascript
const disconnectSync = () => {
    if (stompClientRef.current) {
        try {
            if (subscriptionRef.current) {
                subscriptionRef.current.unsubscribe();  // êµ¬ë… í•´ì œ
            }
            stompClientRef.current.deactivate();       // ì—°ê²° í•´ì œ
        } catch (e) {}
        stompClientRef.current = null;
        subscriptionRef.current = null;
    }
};

// ë¸Œë¼ìš°ì € ë‹«ì„ ë•Œ ì²˜ë¦¬
useEffect(() => {
    const handleBeforeUnload = () => {
        disconnectSync();
    };
    window.addEventListener('beforeunload', handleBeforeUnload);

    return () => {
        window.removeEventListener('beforeunload', handleBeforeUnload);
        disconnectSync();
    };
}, []);
```

**ì™œ beforeunloadì—ì„œ ì²˜ë¦¬í•˜ë‚˜?**
```
ì‚¬ìš©ìê°€ ë¸Œë¼ìš°ì € íƒ­ì„ ë‹«ì„ ë•Œ:
1. beforeunload ì´ë²¤íŠ¸ ë°œìƒ
2. disconnectSync() í˜¸ì¶œ
3. WebSocket ì—°ê²° ì •ë¦¬
4. ì„œë²„ê°€ disconnect ê°ì§€ â†’ LEAVE ì²˜ë¦¬

ì´ ì²˜ë¦¬ê°€ ì—†ìœ¼ë©´:
â†’ ì„œë²„ê°€ ì—°ê²°ì´ ëŠê¸´ ê²ƒì„ ëª¨ë¦„ â†’ currentUsers ì¹´ìš´í„°ê°€ ì•ˆ ì¤„ì–´ë“¦
â†’ "ì±„íŒ…ë°©ì— 10ëª…"ì¸ë° ì‹¤ì œë¡œëŠ” 2ëª… ê°™ì€ ìƒí™© ë°œìƒ
```

### 4.5 useRef ì‚¬ìš© ì´ìœ 

```javascript
const stompClientRef = useRef(null);
const nicknameRef = useRef('');
```

**useState vs useRef**:
```
useState:
- ê°’ì´ ë³€ê²½ë˜ë©´ ì»´í¬ë„ŒíŠ¸ê°€ ë‹¤ì‹œ ë Œë”ë§ë¨
- ë¹„ë™ê¸° ì½œë°±ì—ì„œ ìµœì‹ ê°’ì„ ì°¸ì¡° ëª» í•  ìˆ˜ ìˆìŒ

useRef:
- ê°’ì´ ë³€ê²½ë˜ì–´ë„ ë¦¬ë Œë”ë§ ì•ˆ ë¨
- .currentë¡œ í•­ìƒ ìµœì‹ ê°’ ì ‘ê·¼ ê°€ëŠ¥
- ë¹„ë™ê¸° ì½œë°±(WebSocket ì´ë²¤íŠ¸)ì—ì„œ ì•ˆì „í•˜ê²Œ ì‚¬ìš© ê°€ëŠ¥
```

```javascript
// ë¬¸ì œ ìƒí™©
const [nickname, setNickname] = useState('');
// WebSocket ì½œë°±ì€ ìƒì„± ì‹œì ì˜ nickname ê°’ì„ ìº¡ì²˜ (closure)
// â†’ nicknameì´ ''ì¸ ì‹œì ì— ì½œë°±ì´ ìƒì„±ë˜ë©´ í•­ìƒ '' ì°¸ì¡°

// í•´ê²°: ref ì‚¬ìš©
const nicknameRef = useRef('');
// â†’ nicknameRef.currentëŠ” í•­ìƒ ìµœì‹ ê°’
```

---

## 5. ìµëª… ë‹‰ë„¤ì„ ì‹œìŠ¤í…œ

```
ì±„íŒ…ë°© ì…ì¥ ìˆœì„œ:
1ë²ˆì§¸ ì‚¬ìš©ì â†’ "åŒ¿å1"
2ë²ˆì§¸ ì‚¬ìš©ì â†’ "åŒ¿å2"
3ë²ˆì§¸ ì‚¬ìš©ì â†’ "åŒ¿å3"

ëª¨ë“  ì‚¬ìš©ìê°€ í‡´ì¥í•˜ë©´:
â†’ nicknameCounterê°€ 0ìœ¼ë¡œ ë¦¬ì…‹
â†’ ë‹¤ìŒ ì‚¬ìš©ìëŠ” ë‹¤ì‹œ "åŒ¿å1"ë¶€í„° ì‹œì‘
```

**ì™œ ìµëª… ë‹‰ë„¤ì„ì¸ê°€?**
- ì±„íŒ…ì˜ ììœ ë¡œìš´ ë¶„ìœ„ê¸°ë¥¼ ìœ„í•´
- ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ì‚¬ìš©ìë„ ì°¸ì—¬ ê°€ëŠ¥
- í”„ë¼ì´ë²„ì‹œ ë³´í˜¸

---

## 6. ë©”ì‹œì§€ íƒ€ì…ë³„ ì²˜ë¦¬

```jsx
{messages.map((msg, index) => {
    // ì‹œìŠ¤í…œ ë©”ì‹œì§€ (ì…ì¥/í‡´ì¥)
    if (msg.type === 'JOIN' || msg.type === 'LEAVE') {
        return (
            <div className="chat-system">
                ğŸ‘‹ {msg.content}
            </div>
        );
    }

    // ì¼ë°˜ ì±„íŒ… ë©”ì‹œì§€
    const isMe = msg.senderNickname === nickname;
    return (
        <div className={`chat-msg ${isMe ? 'mine' : 'other'}`}>
            {!isMe && <span className="msg-sender">{msg.senderNickname}</span>}
            <div className="msg-bubble">
                <span className="msg-text">{msg.content}</span>
                <span className="msg-time">{formatTime(msg.createdAt)}</span>
            </div>
        </div>
    );
})}
```

#### ë©”ì‹œì§€ í‘œì‹œ ê·œì¹™

| íƒ€ì… | í‘œì‹œ ë°©ì‹ | ì˜ˆì‹œ |
|------|----------|------|
| JOIN | ì¤‘ì•™ ì‹œìŠ¤í…œ ë©”ì‹œì§€ | ğŸ‘‹ åŒ¿å1ã•ã‚“ãŒå…¥å®¤ã—ã¾ã—ãŸ |
| LEAVE | ì¤‘ì•™ ì‹œìŠ¤í…œ ë©”ì‹œì§€ | ğŸ‘‹ åŒ¿å1ã•ã‚“ãŒé€€å®¤ã—ã¾ã—ãŸ |
| CHAT (ë‚´ ë©”ì‹œì§€) | ì˜¤ë¥¸ìª½ ì •ë ¬, ì´ë¦„ ì—†ìŒ | [ì•ˆë…•í•˜ì„¸ìš”!] |
| CHAT (ìƒëŒ€ ë©”ì‹œì§€) | ì™¼ìª½ ì •ë ¬, ì´ë¦„ í‘œì‹œ | åŒ¿å2: [ë°˜ê°‘ìŠµë‹ˆë‹¤!] |

---

## 7. ìì£¼ ë°œìƒí•˜ëŠ” ì—ëŸ¬ì™€ í•´ê²°ë²•

### ì—ëŸ¬ 1: WebSocket ì—°ê²° ì‹¤íŒ¨

```
WebSocket connection to 'ws://localhost:8080/ws/chat' failed
```

**ì›ì¸**: ë°±ì—”ë“œ WebSocketConfigê°€ ì—†ê±°ë‚˜, Tomcatì´ WebSocketì„ ì§€ì›í•˜ì§€ ì•ŠìŒ

**í•´ê²°**:
- `WebSocketConfig.java`ê°€ ì œëŒ€ë¡œ ë“±ë¡ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
- `pom.xml`ì— `spring-websocket` ì˜ì¡´ì„± í™•ì¸
- CORS ì„¤ì •ì—ì„œ `setAllowedOriginPatterns("*")` í™•ì¸

### ì—ëŸ¬ 2: ë©”ì‹œì§€ë¥¼ ë³´ëƒˆëŠ”ë° ì•ˆ ë³´ì„

**ì›ì¸**: subscribe ê²½ë¡œì™€ publish ê²½ë¡œ ë¶ˆì¼ì¹˜

```
ì˜¬ë°”ë¥¸ ì¡°í•©:
publish â†’ /app/chat/1/send    (í´ë¼ì´ì–¸íŠ¸ â†’ ì„œë²„)
subscribe â†’ /topic/chat/1     (ì„œë²„ â†’ í´ë¼ì´ì–¸íŠ¸)

í‹€ë¦° ì¡°í•©:
publish â†’ /topic/chat/1/send  (âŒ /appì´ì–´ì•¼ í•¨)
subscribe â†’ /app/chat/1       (âŒ /topicì´ì–´ì•¼ í•¨)
```

### ì—ëŸ¬ 3: ë‹‰ë„¤ì„ì´ undefined

**ì›ì¸**: ë‹‰ë„¤ì„ í• ë‹¹ API í˜¸ì¶œ ì‹¤íŒ¨ ë˜ëŠ” ì‘ë‹µ í˜•ì‹ ë¶ˆì¼ì¹˜

**í™•ì¸**: Network íƒ­ì—ì„œ `/api/chat/rooms/1/nickname` ì‘ë‹µ í™•ì¸

### ì—ëŸ¬ 4: ë©”ì‹œì§€ ì‹œê°„ì´ ì´ìƒí•˜ê²Œ í‘œì‹œë¨

**ì›ì¸**: ì„œë²„(Java LocalDateTime)ì™€ í´ë¼ì´ì–¸íŠ¸(JavaScript Date)ì˜ ë‚ ì§œ í˜•ì‹ ì°¨ì´

```javascript
// ì„œë²„ì—ì„œ [2026,2,6,15,30,0] ë°°ì—´ë¡œ ì˜¬ ìˆ˜ ìˆìŒ
const formatTime = (dateString) => {
    const [year, month, day, hour, min, sec] = String(dateString).split(',').map(Number);
    const date = new Date(year, month - 1, day, hour, min, sec);
    // JavaScriptì˜ monthëŠ” 0ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ -1 í•„ìš”!
    return date.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
};
```

### ì—ëŸ¬ 5: ì±„íŒ…ë°©ì—ì„œ ë‚˜ê°”ëŠ”ë° currentUsersê°€ ì•ˆ ì¤„ì–´ë“¦

**ì›ì¸**: beforeunloadì—ì„œ ì •ë¦¬ê°€ ì•ˆ ë˜ì—ˆê±°ë‚˜, ì„œë²„ì˜ disconnect ê°ì§€ ì‹¤íŒ¨

**í•´ê²°**: WebSocketEventListenerë¥¼ ì„œë²„ì— ë“±ë¡í•˜ì—¬ disconnect ì´ë²¤íŠ¸ë¥¼ í™•ì‹¤íˆ ì²˜ë¦¬

---

> ì´ì „ ë¬¸ì„œ: [04. ê´€ë¦¬ì/ì‹ ê³  í˜ì´ì§€ êµ¬í˜„ ê°€ì´ë“œ](./04_ê´€ë¦¬ì_ì‹ ê³ _í˜ì´ì§€_êµ¬í˜„_ê°€ì´ë“œ.md)
> ë‹¤ìŒ ë¬¸ì„œ: [06. ê¸°ë³¸ ê²Œì‹œíŒ CRUD êµ¬í˜„ ê°€ì´ë“œ](./06_ê²Œì‹œíŒ_CRUD_êµ¬í˜„_ê°€ì´ë“œ.md)
